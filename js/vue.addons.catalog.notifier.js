window.$app.defineComponent("addons.catalog.notifier","vue-addons-catalog-notifier-options",{props:["values","variants","addon_id","isInstalling","currentTab"],mixins:[FormModel],data:function(){return{deletingIndex:-1,currentPlatform:"tg",email:"",errors:{},sendingInvite:!1,addingSlack:!1,platforms:{tg:"Telegram",email:"Email",slack:"Slack",vk:"ВКонтакте"},slackChannels:null,slackChannel:null,slackAccessToken:""}},created:function(){this.$io.on("events:addons.notifier:connected",this.connected),this.$io.on("events:addons.notifier:added",this.eventAdded),this.$io.on("events:addons.notifier:deleted",this.eventDeleted)},destroyed:function(){this.$io.off("events:addons.notifier:connected",this.connected),this.$io.off("events:addons.notifier:added",this.eventAdded),this.$io.off("events:addons.notifier:deleted",this.eventDeleted)},computed:{command:function(){return"/start "+this.values.code},messageVK:function(){return this.message('href="https://vk.me/taplink" target="_blank"',"@taplink")},messageFB:function(){return this.message('href="https://m.me/taplink.cc" target="_blank"',"@taplink")},messageTG:function(){return this.message('href="tg://resolve?domain=taplink_bot" target="_blank"',"@taplink_bot")},messageTGAuto:function(){return this.$format(this.$gettext("Для автоматической установки просто перейдите по <a {1}>ссылке</a>"),'href="tg://resolve?domain=taplink_bot&start='+this.values.code+'" target="_blank"')},slackConnectUrl:function(){return"https://slack.com/oauth/v2/authorize?scope=chat:write,channels:read,channels:join,channels:manage&client_id=245995438982.1516803845941&redirect_uri="+encodeURI("https://"+document.location.host.replace("dev.","")+"/addons/installed/notifier/slack/")}},methods:{eventAdded:function(e){this.values.accounts.push(e),this.$parent.save(!1)},eventDeleted:function(e){for(i=this.values.accounts.length-1;0<=i;i--)this.values.accounts[i].notify_provider_id==e.notify_provider_id&&this.values.accounts[i].id==e.id&&this.values.accounts.splice(i,1)},connected:function(e){var s;"success"==e.result&&(s=e.response,this.slackChannels=s.channels,this.slackAccessToken=s.access_token)},addSlack:function(){var s=this;this.addingSlack=!0,this.$parent.action("connect",{type:"slack",id:this.slackChannel,name:this.slackChannels[this.slackChannel],access_token:this.slackAccessToken}).then(function(e){s.slackChannels=s.slackChannel=null,s.slackAccessToken="",s.addingSlack=!1,s.currentTab="accounts"})},inviteEmail:function(){var s=this;this.sendingInvite=!0,this.$parent.action("invite",{email:this.email.trim()}).then(function(e){"success"==e.result?(s.errors={},s.email=""):s.errors=e.errors,s.sendingInvite=!1})},message:function(e,s){return this.$format(this.$gettext("Для подключения уведомлений откройте чат <a {1}>{2}</a> и отправьте команду"),e,s)},deleteAcount:function(s,e,t){var n=this;this.$confirm(this.$gettext("Вы уверены что хотите отключить этот аккаунт?"),"is-danger").then(function(){n.deletingIndex=s,n.$parent.action("delete",{notify_provider_id:e,id:t}).then(function(e){"success"==e.result&&n.values.accounts.splice(s,1),n.deletingIndex=-1})})}},template:'<section class="modal-card-body modal-card-body-blocks"> <section class="content" v-if="currentTab == \'description\'"> <slot name="allow"></slot> <p>{{\'Подключите модуль "Уведомления", чтобы подключить моментальные оповещения о новых заявках и принятых оплатах в мессенджеры\'|gettext}}</p> </section> <section v-if="currentTab == \'options\'"> <p class="has-mb-2">{{\'Для того чтобы настроить уведомления выберите платформу и следуйте инструкциям\'|gettext}}</p> <div class="addons-notifier-types"> <div v-for="(p, k) in platforms" @click="currentPlatform = k" :class="{in: currentPlatform== k}"> <img :src="\'/s/i/messengers/icons/\'+k+\'.svg\'"> </div> </div> </section> <section v-if="currentTab == \'options\' && (currentPlatform == \'vk\')"> <h3 class="has-mb-1">{{\'ВКонтакте\'|gettext}}</h3> <span v-html="messageVK"></span> <span class=\'tag is-success\'>{{command}}</span> <vue-component-clipboard :text="command" class="has-ml-1" :success-message="\'Код скопирован\'|gettext"></vue-component-clipboard> </section> <section v-if="currentTab == \'options\' && (currentPlatform == \'fb\')"> <h3 class="has-mb-1">Facebook Messenger</h3> <span v-html="messageFB"></span> <span class=\'tag is-success\'>{{command}}</span> <vue-component-clipboard :text="command" class="has-ml-1" :success-message="\'Код скопирован\'|gettext"></vue-component-clipboard> </section> <section v-if="currentTab == \'options\' && (currentPlatform == \'tg\')"> <h3 class="has-mb-1">Telegram</h3> <span v-html="messageTG"></span> <span class=\'tag is-success\'>{{command}}</span> <vue-component-clipboard :text="command" class="has-ml-1" :success-message="\'Код скопирован\'|gettext"></vue-component-clipboard><br> <span v-html="messageTGAuto"></span> </section> <section v-if="currentTab == \'options\' && (currentPlatform == \'email\')"> <h3 class="has-mb-1">Email</h3> <b-field :message="errors.email" :class="{\'has-error\': errors.email}"> <div class="row row-small"> <div class="col-xs-12 col-sm-4"> <input type="text" v-model="email" class="input has-mb-1" :disabled="sendingInvite" placeholder="name@mail.com"> </div> <div class="col-xs-12 col-sm-3"> <button class="button is-success is-fullwidth" :class="{\'is-loading\': sendingInvite}" :disabled="sendingInvite" @click="inviteEmail">{{\'Отправить приглашение\'|gettext}}</button> </div> </div> </b-field> </section> <section v-if="currentTab == \'options\' && (currentPlatform == \'slack\')"> <h3 class="has-mb-1">Slack</h3> <div v-if="slackChannels"> <b-field :title="\'Канал\'|gettext"> <div class="row row-small"> <div class="col-xs-12 col-sm-4"> <b-select v-model="slackChannel" :placeholder="\'-- Выберите канал --\'|gettext" expanded> <option v-for="(name, id) in slackChannels" :value="id">{{name|gettext}}</option> </b-select> </div> <div class="col-xs-12 col-sm-3"> <button class="button is-success is-fullwidth" :class="{\'is-loading\': addingSlack}" :disabled="addingSlack" @click="addSlack">{{\'Подключить\'|gettext}}</button> </div> </div> </b-field> </div> <a class="button is-success" :href="slackConnectUrl" target="_blank" v-else>{{\'Подключить Slack\'|gettext}}</button> </section> <section v-if="currentTab == \'accounts\'"> <mx-item class="is-hidden-mobile mx-item-header"> <div class="item-row row"> <div class="col-sm">{{\'Подключения\'|gettext}}</div> </div> </mx-item> <mx-item v-for="(f, index) in values.accounts"> <div class="item-row row"> <div class="col-xs text-xs-bold"><p class="form-control-static"> <a target="_blank" :href="f.link" v-if="f.link">{{f.username}}</a> <span v-else>{{f.username}}</span> <span class="has-text-grey-light"> / {{f.notify_provider_title|gettext}}</span></p> </div> <div class="col-xs col-shrink"><button class="button is-danger" @click="deleteAcount(index, f.notify_provider_id, f.id)" :class="{\'is-loading\': deletingIndex== index, \'disabled\': deletingIndex != -1}"><i class="fa fa-trash-alt"></i></button></div> </div> </mx-item> </section> <section v-if="currentTab == \'types\'"> <div> <b-checkbox v-model="values.options.events.lead"> {{\'Новая заявка\'|gettext}}</b-checkbox> </div> <div> <b-checkbox v-model="values.options.events.paid"> {{\'Новая оплата\'|gettext}}</b-checkbox> </div> <div> <b-checkbox v-model="values.options.events.notify"> {{\'Уведомления об ошибках\'|gettext}}</b-checkbox> </div> </section> </section>'}),window.$app.defineModule("addons.catalog.notifier",[]);
