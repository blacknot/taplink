window.$app.defineComponent("design","vue-design-editor",{data:function(){return{}},props:["theme","group_id","design_id"],watch:{theme:{handler:function(){this.$emit("update:theme",this.theme)},deep:!0}},template:'<div :class="{disabled: design_id != 0 || !$auth.isAllowTariff(\'pro\')}"> <h3 class="has-text-grey has-mb-1 has-text-centered-mobile">{{\'Текст\'|gettext}}</h3> <div class="has-mb-4"> <div class="has-mb-2"> <vue-component-colorpicker v-model="theme.options.screen.color" :label="\'Цвет текста\'|gettext" :disabled="design_id != 0"></vue-component-colorpicker> </div> <div class="has-mb-2"> <vue-component-colorpicker v-model="theme.options.avatar.color" :label="\'Цвет названия профиля\'|gettext" :disabled="design_id != 0"></vue-component-colorpicker> </div> <div class="link-styles-container"> <label class="form-control-static">{{\'Шрифт\'|gettext}}</label> <vue-component-font-chooser v-model="theme.options.screen.font" view="name"></vue-component-font-chooser> </div> </div> <h3 class="has-text-grey has-mb-1 has-text-centered-mobile">{{\'Ссылки\'|gettext}}</h3> <div class="has-mb-4"> <div class="has-mb-2"> <vue-component-colorpicker v-model="theme.options.link.color" :label="\'Цвет текста ссылки\'|gettext" v-on:input="theme.options.link.color = $event" :disabled="design_id != 0"></vue-component-colorpicker> </div> <div class="has-mb-2"> <vue-component-colorpicker v-model="theme.options.link.bg" :label="\'Цвет фона ссылки\'|gettext" :disabled="design_id != 0"></vue-component-colorpicker> </div> <div class="has-mb-2"><mx-toggle v-model="theme.options.link.transparent" :space-between="true" :title="\'Прозрачная ссылка\'|gettext" :disabled="design_id != 0"></mx-toggle></div> <div class="has-mb-2 link-styles-container"> <label class="form-control-static">{{\'Эффект при наведении\'|gettext}}</label> <div class="select"> <select v-model="theme.options.link.hover" :disabled="design_id != 0"> <option value="0">{{\'Нет\'|gettext}}</option> <option value="1">{{\'Прозрачность\'|gettext}}</option> <option value="2">{{\'Увеличение\'|gettext}}</option> </select> </div> </div> <div class="has-mb-2 link-styles-container"> <label class="form-control-static">{{\'Закругленная ссылка\'|gettext}}</label> <ul class="link-styles is-radius-style"> <li class="link-styles-center" :class="{in: theme.options.link.radius == \'40px\'}" @click="theme.options.link.radius = \'40px\'" style="border-radius:40px"><dd></dd></li> <li class="link-styles-center" :class="{in: theme.options.link.radius == \'12px\'}" @click="theme.options.link.radius = \'12px\'" style="border-radius:8px"><dd></dd></li> <li class="link-styles-center" :class="{in: theme.options.link.radius == \'\'}" @click="theme.options.link.radius = \'\'"><dd></dd></li> </ul> </div> <div class="link-styles-container"> <label class="form-control-static">{{\'Стиль ссылки\'|gettext}}</label> <ul class="link-styles"> <li class="link-styles-center" :class="{in: theme.options.link.align == \'center\'}" @click="theme.options.link.align = \'center\'"><dd></dd></li> <li class="link-styles-left fa" :class="{in: theme.options.link.align == \'left\'}" @click="theme.options.link.align = \'left\'"><dd></dd></li> </ul> </div> </div> <h3 class="has-text-grey has-mb-1 has-text-centered-mobile">{{\'Фон\'|gettext}}</h3> <div class="has-mb-2"> <div v-if="!theme.extended_id"> <vue-component-background-editor v-model="theme.options.bg"></vue-component-background-editor> <mx-toggle v-model="theme.options.bg.fixed" :space-between="true" :title="\'Фиксировать при прокрутке\'|gettext"></mx-toggle> </div> </div>'}),window.$app.defineComponent("design","vue-design-index",{data:function(){return{isUpdating:!1,isSetting:!1,isFetching:!1,isDeleting:!1,isAllowPro:!1,groups:{1:this.$gettext("Стандартные")},designs:[],designsTitles:[],themes:{},design_id:null,theme_id:null,current_theme_id:null,current_design_id:null,fetchingGroups:[],isFetchingThemes:!1,deltaMouseWheel:0,timerMouseWheel:0,isEditMode:!1,tmpTheme:null,deviceFix:"",buttonsPanelFix:"",themeIndex:0,select_theme:null}},props:["group_id","page_id"],created:function(){this.isAllowPro=this.$auth.isAllowTariff("pro"),this.select_theme=this.$account.theme,this.current_theme_id=this.$account.theme_id,this.fetchData(!0),$mx(window).on("resize orientationchange scroll",this.scrollCheck)},destroyed:function(){$mx(window).off("resize orientationchange scroll",this.scrollCheck)},computed:{menu:function(){return _.map(this.groups,function(e,t){return{name:"design",meta:{title:e},params:{group_id:t}}})},designTitle:function(){return this.isEditMode?this.$gettext("Редактирование"):0==this.design_id?this.$gettext("Мои дизайны"):null!=this.designsTitles[this.design_id]?this.$gettext(this.designsTitles[this.design_id]):this.$gettext("Выберите цветовую схему")}},mixins:[FormModel],watch:{group_id:function(){this.fetchData(),this.isEditMode&&this.editThemeCancel()},theme_id:function(e){this.setThemeId(e)}},methods:{scrollCheckForce:function(){this.$nextTick(this.scrollCheck)},scrollCheck:function(){var e=window.scrollY,t=document.documentElement.clientHeight;this.deviceFix=e>this.$refs.device.offsetTop-30?"position:fixed;top:30px":"",this.buttonsPanelFix=null!=this.$refs.buttonsPanel&&e+t<this.$refs.device.offsetTop+600+this.$refs.buttonsPanel.clientHeight+30?"position:sticky;bottom:30px;top:auto":""},setThemeId:function(e){for(var t=0,i=0;i<this.themes[this.design_id].length;i++){var s=this.themes[this.design_id][i];if(s.theme_id==e){t=i,this.select_theme=s;break}}this.themeIndex=t},themeChanged:function(e){this.prepareThemes([e])},editTheme:function(){this.isAllowPro&&(this.design_id?this.$confirm(this.$gettext("Вы хотите создать новую тему на основе этой?"),"is-warning",{yes:"Да",no:"Нет"}).then(this.editThemeInternal):(this.tmpTheme=this.$clone(this.themes[this.design_id][this.themeIndex]),this.isEditMode=!0))},editThemeCancel:function(){this.prepareThemes(this.themes[this.design_id]),this.tmpTheme=null,this.isEditMode=!1},editThemeSave:function(){var t=this,i=this.themes[this.design_id][this.themeIndex]=this.select_theme=this.tmpTheme;this.isUpdating=!0,this.$api.post("settings/design/update",{theme_id:this.theme_id,options:this.select_theme.options},this).then(function(e){"success"==e.result&&t.theme_id==t.current_theme_id&&(t.$account.theme=i.options,t.$auth.refreshStyles()),t.isUpdating=!1,t.editThemeCancel()}).catch(function(e){t.isUpdating=!1})},newTheme:function(){var e=this;this.isAllowPro?this.$confirm(this.$gettext("Вы хотите создать новую тему?"),"is-warning",{yes:"Да",no:"Нет"}).then(function(){e.editThemeInternal()}):this.$alert(this.$gettext("Своя тема доступна в pro-тарифе").replace("<br>"," "),"is-danger")},editThemeInternal:function(){var i=this;this.isUpdating=!0,this.$api.post("design/create",{theme_id:this.theme_id},this).then(function(e){if("success"==e.result){var t=e.response;i.group_id=1,i.design_id=0,i.prepareThemes(t.themes),i.themes[0]=t.themes,i.setThemeId(i.theme_id=t.theme_id),i.editTheme()}i.isUpdating=!1}).catch(function(e){i.isUpdating=!1})},themesMouseWheel:function(e){var t=this;Math.abs(e.deltaX)>Math.abs(e.deltaY)&&(e.preventDefault(),this.deltaMouseWheel+=e.deltaX,this.deltaMouseWheel<0&&0==this.themeIndex&&(this.deltaMouseWheel=0),0<this.deltaMouseWheel&&null!=this.themes[this.design_id]&&this.themeIndex==this.themes[this.design_id].length-1&&(this.deltaMouseWheel=0),395<this.deltaMouseWheel?(this.themeIndex++,this.deltaMouseWheel-=395):this.deltaMouseWheel<-395&&(this.themeIndex--,this.deltaMouseWheel+=395),this.theme_id=this.themes[this.design_id][this.themeIndex].theme_id,this.timerMouseWheel&&clearTimeout(this.timerMouseWheel),this.timerMouseWheel=setTimeout(function(){200<t.deltaMouseWheel?t.themeIndex++:t.deltaMouseWheel<-200&&t.themeIndex--,t.theme_id=t.themes[t.design_id][t.themeIndex].theme_id,t.deltaMouseWheel=0},250))},fetchData:function(){var i=this;if(null==this.designs[this.group_id]){var s=this.group_id;this.designs.length?(this.fetchingGroups[s]=[1,2,3],this.$api.get("design/designs",{group_id:s}).then(function(e){i.isFetching=!1;var t=e.response;i.fetchingGroups[s]=[],i.$set(i.designs,s,i.prepareDesigns(t.designs)),i.scrollCheckForce()})):this.$api.get("design/current",{group_id:s}).then(function(e){i.isFetching=!1;var t=e.response;i.groups=t.groups,i.designs[t.group_id]=i.prepareDesigns(t.designs),i.group_id=t.group_id,i.themes[t.design_id]=t.themes,i.current_design_id=i.design_id=t.design_id,i.theme_id=t.theme_id,i.prepareThemes(t.themes),i.scrollCheckForce()})}},prepareDesigns:function(e){var t=this;return _.each(e,function(e){null==e.options.bg.opacity?e.options.bg.opacity="0.95":e.options.bg.opacity=e.options.bg.opacity.toString(),e.styles=t.buildStyles(e),t.designsTitles[e.design_id]=e.title}),e},prepareThemes:function(e){var t="";_.each(e,function(e){e.theme_id&&(t+=buildStyles(e.options,"design",".theme"+e.theme_id))}),StylesFactory.updateCSSBlock(t,this.$refs.styles)},fetchThemes:function(s){var n=this;return new Promise(function(i,e){null==n.themes[s]?(n.isFetchingThemes=!0,n.themeIndex=0,n.$api.get("design/themes",{design_id:s}).then(function(e){var t=e.response;n.themes[s]=t.themes,n.isFetchingThemes=!1,i(t.themes)})):i(n.themes[s])})},buildStyles:function(e){var t=this.$clone(e.options);t.link.transparent&&(t.link.border=t.link.bg,t.link.bg=null);switch(t.bg.size){case"width":"background-size: 100% auto";break;case"cover":"background-size: cover"}return{html_thumb:buildStylesBackground(t,"html","thumb"),body_thumb:buildStylesBackground(t,"body","thumb")+";color: "+t.screen.color+(e.thumb?";background:url("+e.thumb+")":""),link:"background: "+(t.link.bg?t.link.bg:"transparent")+";border-color:"+(t.link.border?t.link.border:t.link.bg)+";color: "+t.link.color+(t.link.radius?";border-radius:"+t.link.radius:""),link_class:"left"==t.link.align?"btn-link-align-left":""}},setGroup:function(e){var t=this;this.group_id=e,this.$nextTick(function(){t.$refs.scroll.scrollTo(0,0),0==e&&t.$refs.tabs.scrollTo(0,0)})},selectDesign:function(t){var i=this;this.isEditMode&&this.editThemeCancel(),this.design_id=t,this.fetchThemes(t).then(function(e){i.prepareThemes(e),i.theme_id=e.length?i.current_design_id==t?i.current_theme_id:e[0].theme_id:null})},setTheme:function(e){var t=this;if(!e.is_pro||this.isAllowPro){this.isSetting=!0;var i=this.theme_id,s=this.design_id;this.$api.post("settings/design/set",{theme_id:i},this).then(function(e){"success"==e.result&&(t.$account.theme_id=t.current_theme_id=i,t.$account.theme=e.response.theme,t.current_design_id=s,t.$auth.refreshStyles(),t.current_theme=t.$account.theme,t.current_style=t.$account.styles),t.isSetting=!1}).catch(function(e){t.isSetting=!1})}},deleteTheme:function(){var i=this;this.$confirm(this.$gettext("Вы уверены что хотите удалить эту тему?"),"is-danger").then(function(){i.isDeleting=!0,i.$api.post("design/delete",{theme_id:i.theme_id},i).then(function(e){if("success"==e.result){var t=i.themes[i.design_id];t.splice(i.themeIndex,1),i.themeIndex=Math.min(i.themeIndex,t.length-1),i.theme_id=t[i.themeIndex].theme_id}i.isDeleting=!1})})}},template:'<div style="background: #fff"> <vue-component-submenu :menu="menu" :page_id="page_id"></vue-component-submenu> <div ref=\'styles\'></div> <div class="design-list"> <div class="design-item" v-if="group_id == 1 && (fetchingGroups[group_id] == undefined || !fetchingGroups[group_id].length)"> <div class="design-block" :class="{in: !design_id, current: !current_design_id}" @click="selectDesign(0)"> <span class="tag is-pro" v-tippy :content="\'Своя тема доступна в pro-тарифе\'|gettext" v-if="!isAllowPro">pro</span> <div style="border: 1px dashed #aaa;box-shadow: none;"><div> <div class="design-block-btn" style="border:1px dashed #aaa;border-radius: 40px">{{\'Мои дизайны\'|gettext}}</div> </div> </div> <svg width="16" height="6" xmlns="http://www.w3.org/2000/svg" v-if="0 == design_id"><path d="M0 6s1.796-.013 4.67-3.615C5.851.9 6.93.006 8 0c1.07-.006 2.148.887 3.343 2.385C14.233 6.005 16 6 16 6H0z"></svg> </div> </div> <div class="design-item" v-for="i in fetchingGroups[group_id]"> <div class="design-block"> <div style="border: 1px solid #d9d9d9;box-shadow: none;"><div> <div><div> <span class="skeleton" style="margin:0 auto;width: 60%">Text</span> <div class="design-block-btn skeleton">Link</div> </div> </div> </div></div> </div> </div> <div class="design-item" v-for="(t, index) in designs[group_id]"> <div class="design-block" :class="{in: t.design_id == design_id, current: t.design_id == current_design_id}" @click="selectDesign(t.design_id)"> <span class="tag is-pro" v-tippy :content="\'Эта тема доступна в pro-тарифе\'|gettext" v-if="t.is_pro && !isAllowPro">pro</span> <div :style="t.styles.html_thumb"><div :style="t.styles.body_thumb"> {{\'Текст\'|gettext}} <div class="design-block-btn" :class="t.styles.link_class" :style="t.styles.link">{{\'Ссылка\'|gettext}}</div> </div> </div> <svg width="16" height="6" xmlns="http://www.w3.org/2000/svg" v-if="t.design_id == design_id"><path d="M0 6s1.796-.013 4.67-3.615C5.851.9 6.93.006 8 0c1.07-.006 2.148.887 3.343 2.385C14.233 6.005 16 6 16 6H0z"></svg> </div> </div> </div> <h4 class="has-mt-5 has-text-centered" style="text-transform: uppercase">{{designTitle}}</h4> <div class="has-mt-5 has-mb-4" :class="{container: isEditMode}" style="position:relative;min-height: 800px" @mousewheel="themesMouseWheel" ref="device"> <div style="top:0;width: 100%" :class="{\'has-text-centered\': !isEditMode}" :style="isFetchingThemes?\'\':\'position:absolute\'"> <div class="device is-large has-shadow" :style="isEditMode?deviceFix:\'\'"> <div class="screen page" style="background: transparent !important"></div> <b-loading :is-full-page="false" :active.sync="isFetchingThemes"></b-loading> </div> </div> <div class="themes-list" :class="{editmode: isEditMode}" :style="isEditMode?deviceFix:\'\'"> <div :style="{display: \'flex\', transform: \'translate(-\'+((themeIndex*395)+deltaMouseWheel)+\'px, 0)\'}"> <div class="device is-large has-transparent" :class="[{in: themeIndex== i, current: current_theme_id== t.theme_id, \'is-edit-mode\': isEditMode}, \'theme\'+t.theme_id, \'is-\'+t.options.bg.brightness]" v-for="(t, i) in themes[design_id]"> <div class="screen page" @click="theme_id = t.theme_id"> <div class="theme-main" v-if="t.theme_id"> <div v-html="t.options.html"></div> <div class="blocks-list has-pt-2 has-pb-2" v-if="t.theme_id"> <div class="blocks-item has-pb-1 has-pt-1"> <div class="block-avatar container"> <div class="has-text-centered"><img :src="$account.avatar.url" class="profile-avatar profile-avatar-65"></div> <div class="has-text-centered text-avatar" v-if="$account.nickname">@{{$account.nickname}}</div> <div class="has-text-centered text-avatar" v-else>@nickname</div> </div> </div> <div class="blocks-item has-pb-1 has-pt-1"> <div class="block-text container"> Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Aenean commodo ligula eget dolor. Aenean massa. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Donec quam felis, ultricies nec, pellentesque eu, pretium quis, sem. Nulla consequat massa quis enim. </div> </div> <div class="blocks-item has-pb-1 has-pt-1"> <div class="block-link block-item container"> <a class="button btn-link btn-link-styled">{{\'Ссылка\'|gettext}} 1</a> </div> </div> <div class="blocks-item has-pb-1 has-pt-1"> <div class="block-link block-item container"> <a class="button btn-link btn-link-styled">{{\'Ссылка\'|gettext}} 2</a> </div> </div> <div class="blocks-item has-pb-1 has-pt-1"> <div class="block-link block-item container"> <a class="button btn-link btn-link-styled">{{\'Ссылка\'|gettext}} 3</a> </div> </div> </div> </div> <div class="theme-main" v-else> <a @click="newTheme" class="plus" :class="{\'is-loading\': isSetting}" v-if="theme_id == t.theme_id"></a> <h3 class="has-mt-3" :class="{\'has-text-grey\': theme_id != t.theme_id}">{{\'Новый дизайн\'|gettext}}</h3> </div> </div> </div> </div> <div class="theme-buttons-panel" :class="{\'is-edit-mode\': isEditMode, hide: theme_id== 0}" v-if="!isFetchingThemes" :style="buttonsPanelFix" ref="buttonsPanel"> <div v-if="isEditMode"> <button class="button is-black is-large" @click="editThemeCancel">{{\'Отменить\'|gettext}}</button> <button class="button is-success is-large" :class="{\'is-loading\': isUpdating}" @click="editThemeSave">{{\'Сохранить\'|gettext}}</button> </div> <div v-else> <button class="button is-danger is-large" style="flex:0" v-if="design_id == 0" :disabled="(current_theme_id == theme_id) || isDeleting" @click="deleteTheme"><i class="fa fa-trash-alt"></i></button> <button class="button is-dark is-large" @click="editTheme">{{\'Редактировать\'|gettext}}</button> <button class="button is-success is-large" :disabled="(theme_id == current_theme_id) || !select_theme || (select_theme.is_pro == 1 && !isAllowPro)" @click="setTheme(select_theme)" :class="{\'is-loading\': isSetting}">{{\'Выбрать тему\'|gettext}}</button> </div> </div> </div> <div v-if="isEditMode" style="flex:1;padding-left:460px"> <vue-design-editor :theme="tmpTheme" :group_id="group_id" :design_id="design_id" @update:theme="themeChanged"></vue-design-editor> </div> </div> </div>'}),window.$app.defineModule("design",[]);
