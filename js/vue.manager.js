window.$app.defineComponent("manager","vue-manager-blog-form",{data:function(){return{currentTab:"text",isUpdating:!1,isFetching:!1,values:{post_id:null,seo_title:"",filename:"",body:"",seo_description:"",is_draft:!0,picture:null},html:"",options:{theme:"snow",modules:{toolbar:"#blogToolbar"}}}},created:function(){this.post_id&&this.fetchData(!0)},props:["post_id"],mixins:[FormModel],computed:{link:function(){return"//taplink.ru/blog/"+this.values.filename+".html"}},methods:{filenameFilter:function(e){var t=e.which?e.which:e.keyCode;String.fromCharCode(t).match(/[A-Za-z0-9\-_]/)||e.preventDefault()},filenameFilterAfter:function(e){e.target.value=e.target.value.toLowerCase().replace(/[^a-z0-9\-_ ]/g,"").trim().replace(/ /g,"_")},setTab:function(e){if(this.currentTab!=e){switch(e){case"text":this.values.body=this.html;break;default:this.html=this.values.body}this.currentTab=e}},fetchData:function(e){var t=this;this.isFetching=e,this.$api.get("manager/blog/get",{post_id:this.post_id}).then(function(e){t.isFetching=!1,t.values=e.response.blog.post,t.html=t.values.body})},updateData:function(){var t=this;this.isUpdating=!0,"html"==this.currentTab&&(this.values.body=this.html),this.$api.post("manager/blog/set",this.values,this).then(function(e){"success"==e.result&&t.$parent.close(),t.isUpdating=!1}).catch(function(e){t.isUpdating=!1})}},template:'<div class="modal-card modal-card-large is-fullscreen"> <header class="modal-card-head"> <p class="modal-card-title"><input v-model="values.title" placeholder="Заголовок" class="title is-2" style="display: block;width: 100%;border: 0"></p> <button class="modal-close is-large" @click="$parent.close()"></button> </header> <ul class="nav nav-tabs has-text-left"> <li :class="{active: currentTab== \'text\'}"><a @click="setTab(\'text\')">Текст</a></li> <li :class="{active: currentTab== \'html\'}"><a @click="setTab(\'html\')">HTML</a></li> <li :class="{active: currentTab== \'common\'}"><a @click="setTab(\'common\')">Настройки</a></li> </ul> <div id="blogToolbar" style="background: #fff" v-show="currentTab == \'text\'"> <div id="toolbar"> <select class="ql-header"><option value="1"></option><option value="2"></option><option value="3"></option><option selected="selected"></option></select> <span class="ql-formats"> <button class="ql-bold"></button> <button class="ql-italic"></button> </span> <span class="ql-formats"> <button class="ql-list" value="ordered"></button> <button class="ql-list" value="bullet"></button> </span> <span class="ql-formats"> <button class="ql-indent" value="-1"></button> <button class="ql-indent" value="+1"></button> </span> <span class="ql-formats"> <button class="ql-blockquote"></button> </span> <span class="ql-formats"> <button class="ql-align" value=""></button> <button class="ql-align" value="center"></button> <button class="ql-align" value="right"></button> <button class="ql-align" value="justify"></button> </span> <span class="ql-formats"> <button class="ql-link"></button> <button class="ql-image"></button> </span> <span class="ql-formats"> <button class="ql-clean"></button> </span> </div> </div> <section class="modal-card-body" v-show="currentTab == \'text\'"> <vue-component-editor :options="options" v-model="values.body" classname="hero-block blog-post" style="max-width: 800px;margin: 0 auto"></vue-component-editor> </section> <section class="modal-card-body" v-show="currentTab == \'html\'"> <textarea v-model="html" class="input" style="height: 100%"></textarea> </section> <section class="modal-card-body" v-if="currentTab == \'common\'"> <b-field label="Имя файла" :message="errors.filename" :class="{\'has-error\': errors.filename}"> <p class="control"> <b-field> <div class="control is-expanded"><input class="input" v-model="values.filename" @keypress="filenameFilter" @change="filenameFilterAfter" @keyup="filenameFilterAfter"></input></div> <div class="control"><a :href="link" target="_blank" class="button is-dark" :class="{disabled: !values.post_id}">Открыть</a></div> </b-field> </p> </b-field> <div class="row"> <div class="col-xs-12 col-md-6"> <label class="label">{{\'Изображение\'|gettext}}</label> <p class="has-text-grey-light">{{\'Размер изображения\'|gettext}}: 600x400 px</p> <vue-component-pictures v-model="values.picture" class="blog-picture" :button-title="\'Загрузить картинку\'|gettext" button-icon="fa fal fa-cloud-upload" updatable></vue-component-pictures> </div> <div class="col-xs-12 col-md-6"> <b-field label="SEO Title"> <b-input maxlength="4096" type="text" v-model="values.seo_title"></b-input> </b-field> <b-field label="SEO Description"> <b-input maxlength="4096" type="textarea" v-model="values.seo_description"></b-input> </b-field> </div> </div> </section> <footer class="modal-card-foot level"> <div class="level-left"> <mx-toggle v-model="values.is_draft" :title="\'Черновик\'|gettext"></mx-toggle> </div> <div class="level-right"> <button class="button is-dark" type="button" @click="$parent.close()">{{\'Закрыть\'|gettext}}</button> <button class="button is-primary" :class="{\'is-loading\': isUpdating}" @click="updateData">{{\'Сохранить\'|gettext}}</button> </div> </footer> <b-loading :is-full-page="false" :active.sync="isFetching"></b-loading> </div>'}),window.$app.defineComponent("manager","vue-manager-blog-list",{data:function(){return{isFetching:!1,filter:{query:""},perPage:20}},mixins:[ListModel],created:function(){this.$io.on("events:manager.blog.list:refresh",this.refresh),this.fetchData(!0)},destroyed:function(){this.$io.off("events:manager.blog.list:refresh",this.refresh)},methods:{onFilter:function(){this.clearPages(),this.fetchData(!0)},refresh:function(){this.fetchData(!1,!0)},fetchData:function(e,t){var s=this;!t&&this.checkCache()||(this.isFetching=e,this.$api.get("manager/blog/list",{next:this.next,count:this.perPage,filter:this.filter}).then(function(e){s.cachePage(e.response.blog),s.isFetching=!1}).catch(function(e){throw s.fields=[],s.total=0,s.isFetching=!1,e}))},onPageChange:function(e){this.page=e,this.fetchData()},clickRow:function(e){this.$form("vue-manager-blog-form",{post_id:e.post_id},this)}},template:'<div> <vue-component-filterbox @filter="onFilter" v-model="filter" :disabled="isFetching" :with-buttons="true"> <template slot="buttons"> <a @click="$form(\'vue-manager-blog-form\')" class="button is-primary is-fullwidth"><i class="fa fa-plus-circle"></i> Добавить пост</a> </template> </vue-component-filterbox> <div class="container"> <div class="has-mb-2"> <b-table paginated backend-pagination pagination-simple :data="fields" :loading="isFetching" :per-page="perPage" :total="total" @page-change="onPageChange" @click="clickRow" hoverable bordered> <b-table-column field="post_id" label="" class="has-width-5" v-slot="props"><div :class="{\'has-text-grey-light\': props.row.is_draft}">{{ props.row.post_id }}</div></b-table-column> <b-table-column field="title" label="Загаловок" v-slot="props"> <div :class="{\'has-text-grey-light\': props.row.is_draft}">{{ props.row.title }}</div> <div class="has-text-danger is-pulled-right" v-if="props.row.is_draft"><i class="fas fa-eye-slash has-ml-1"></i></div> </b-table-column> <b-table-column field="tms_created" label="Дата" numeric v-slot="props"> <div :class="{\'has-text-grey-light\': props.row.is_draft}">{{ props.row.tms_created|date }}</div> </b-table-column> <template slot="empty"> <section class="has-mb-4 has-mt-4 content has-text-grey has-text-centered" v-if="!isFetching"> <p><b-icon icon="frown" size="is-large"></b-icon></p> <p>{{\'Пока ничего нет\'|gettext}}</p> </section> <section class="has-mb-4 has-mt-4 content has-text-grey has-text-centered" v-if="isFetching"> <p>{{\'Загрузка данных\'|gettext}}</p> </section> </template> </b-table> </div> </div> </div>'}),window.$app.defineComponent("manager","vue-manager-currency",{data:function(){return{providers:{},currency:{},data:{}}},created:function(){this.fetchData()},methods:{fetchData:function(){var s=this;this.isFetching=!0,this.$api.get("manager/currency/get").then(function(e){var t=e.response.currency;s.providers=t.providers,s.currency=t.currency,s.data=t.data,s.isFetching=!1}).catch(function(e){throw s.locales=[],e})},changeValue:function(e,t,s){var a=e.target;a.disabled=!0,this.$api.get("manager/currency/set",{payment_provider_id:t,currency_id:s,value:a.checked}).then(function(e){a.disabled=!1})}},template:'<div class="container has-mb-4 has-mt-4"> <div class="row row-small"> <div class="col-sm-2"> <table class="table" style="width: 100%"> <thead> <tr> <td>Провайдер</td> </tr> </thead> <tbody> <tr v-for="(p, i) in providers"> <td>{{p}}</td> </tr> </tbody> </table> </div> <div class="col-sm-10"> <div style="overflow: scroll"> <table class="table"> <thead> <tr> <td v-for="c in currency">{{c}}</td> </tr> </thead> <tbody> <tr v-for="(p, i) in providers"> <td v-for="(c, j) in currency"> <input type="checkbox" :checked="data[i] != undefined && data[i].indexOf(parseInt(j)) != -1" @change="changeValue(event, i, j)"> </td> </tr> </tbody> </table> </div> </div> </div> </div>'}),window.$app.defineComponent("manager","vue-manager-guides-form",{data:function(){return{currentTab:"text",isUpdating:!1,isFetching:!1,values:{filename:"",locales:{}},variants:{language_id:[]},language_id:null,html:"",options:{theme:"snow",modules:{toolbar:"#blogToolbar"}}}},created:function(){this.guide_id&&this.fetchData(!0)},props:["guide_id"],mixins:[FormModel],computed:{hasLocale:function(){return null!=this.values.locales[this.language_id]}},watch:{language_id:function(e,t){"text"!=this.currentTab&&(t&&(this.values.locales[t].body=this.html),this.html=null!=this.values.locales[e]?this.values.locales[e].body:"")}},methods:{filenametFilter:function(e){var t=e.which?e.which:e.keyCode;String.fromCharCode(t).match(/[A-Za-z0-9\-_]/)||e.preventDefault()},activateLocale:function(){this.$set(this.values.locales,this.language_id,{body:"",video_link:null,title:"",is_draft:!0,language_id:this.language_id}),this.html="",this.setTab("text")},filenametFilterAfter:function(e){e.target.value=e.target.value.toLowerCase().replace(/[^a-z0-9\-_ ]/g,"").trim().replace(/ /g,"_")},setTab:function(e){if(this.currentTab!=e){switch(e){case"text":this.values.locales[this.language_id].body=this.html;break;default:this.html=this.values.locales[this.language_id].body}this.currentTab=e}},fetchData:function(e){var t=this;this.isFetching=e,this.$api.get("manager/guides/get",{guide_id:this.guide_id}).then(function(e){t.isFetching=!1,t.values=e.response.guides.values,t.language_id=_.keys(t.values.locales)[0],t.variants=e.response.guides.variants,t.html=t.values.locales[t.language_id].body})},updateData:function(){var t=this;this.isUpdating=!0,"html"==this.currentTab&&(this.values.locales[this.language_id].body=this.html),this.$api.post("manager/guides/set",this.values,this).then(function(e){"success"==e.result&&t.$parent.close(),t.isUpdating=!1}).catch(function(e){t.isUpdating=!1})}},template:'<div class="modal-card modal-card-large is-fullscreen"> <header class="modal-card-head"> <p class="modal-card-title">Инструкция</p> <button class="modal-close is-large" @click="$parent.close()"></button> </header> <ul class="nav nav-tabs has-text-left" v-show="hasLocale"> <li :class="{active: currentTab== \'text\'}"><a @click="setTab(\'text\')">Текст</a></li> <li :class="{active: currentTab== \'html\'}"><a @click="setTab(\'html\')">HTML</a></li> <li :class="{active: currentTab== \'common\'}"><a @click="setTab(\'common\')">Настройки</a></li> </ul> <div id="blogToolbar" style="background: #fff" v-show="currentTab == \'text\' && hasLocale"> <div id="toolbar"> <select class="ql-header"><option value="1"></option><option value="2"></option><option value="3"></option><option selected="selected"></option></select> <span class="ql-formats"> <button class="ql-bold"></button> <button class="ql-italic"></button> </span> <span class="ql-formats"> <button class="ql-list" value="ordered"></button> <button class="ql-list" value="bullet"></button> </span> <span class="ql-formats"> <button class="ql-indent" value="-1"></button> <button class="ql-indent" value="+1"></button> </span> <span class="ql-formats"> <button class="ql-blockquote"></button> </span> <span class="ql-formats"> <button class="ql-align" value=""></button> <button class="ql-align" value="center"></button> <button class="ql-align" value="right"></button> <button class="ql-align" value="justify"></button> </span> <span class="ql-formats"> <button class="ql-link"></button> <button class="ql-image"></button> </span> <span class="ql-formats"> <button class="ql-clean"></button> </span> </div> </div> <section class="modal-card-body" v-show="!hasLocale"> <button class="button" @click="activateLocale">Добавить язык</button> </section> <section class="modal-card-body" v-show="currentTab == \'text\' && hasLocale"> <vue-component-editor :options="options" v-model="values.locales[language_id].body" classname="hero-block blog-post hero-text" style="max-width: 800px;margin: 0 auto" v-if="values.locales[language_id]"></vue-component-editor> </section> <section class="modal-card-body" v-show="currentTab == \'html\' && hasLocale"> <textarea v-model="html" class="input" style="height: 100%"></textarea> </section> <section class="modal-card-body" v-if="currentTab == \'common\' && hasLocale"> <b-field label="Имя файла" :message="errors.filename" :class="{\'has-error\': errors.filename}"> <p class="control"> <b-field> <div class="control is-expanded"><input class="input" v-model="values.filename" @keypress="filenametFilter" @change="filenametFilterAfter" @keyup="filenametFilterAfter"></input></div> </b-field> </p> </b-field> <b-field label="Заголовок"> <input class="input" v-model="values.locales[language_id].title"></input> </b-field> <b-field label="Видео"> <input class="input" v-model="values.locales[language_id].video_link"></input> </b-field> </section> <footer class="modal-card-foot level"> <div class="level-left"> <div class="level-item"> <div class="select"> <select class="input" v-model="language_id"> <option v-for="v in variants.language_id" :value="v.language_id">{{v.language_title}}</option> </select> </div> </div> <div class="level-item"> <mx-toggle v-model="values.locales[language_id].is_draft" :title="\'Черновик\'|gettext" v-if="hasLocale"></mx-toggle> </div> </div> <div class="level-right"> <div class="level-item"> <button class="button is-dark" type="button" @click="$parent.close()">{{\'Закрыть\'|gettext}}</button> <button class="button is-primary" :class="{\'is-loading\': isUpdating}" @click="updateData">{{\'Сохранить\'|gettext}}</button> </div> </div> </footer> <b-loading :is-full-page="false" :active.sync="isFetching"></b-loading> </div>'}),window.$app.defineComponent("manager","vue-manager-guides-list",{data:function(){return{isFetching:!1,filter:{query:""},perPage:20}},mixins:[ListModel],created:function(){this.$io.on("events:manager.guides.list:refresh",this.refresh),this.fetchData(!0)},destroyed:function(){this.$io.off("events:manager.guides.list:refresh",this.refresh)},methods:{implode:function(e){return _.map(e,function(e){return'<div style="display:flex;align-items:center" '+(e.is_draft?'class="has-text-grey-light"':"")+'><span title="ru" class="iti-flag '+e.language_code+' has-mr-1" style="display: inline-block;"></span>'+e.title+"</div>"}).join("")},onFilter:function(){this.clearPages(),this.fetchData(!0)},refresh:function(e){var s=this;null!=e.guide_ids?this.merge(this.fields,"guide_id",e.guide_ids,function(e,t){s.$api.get("manager/guides/list",{filter:{guide_ids:e}}).then(function(e){s.fields=t(e.response.guides.fields)})}):this.fetchData(!1,!0)},fetchData:function(e,t){var s=this;!t&&this.checkCache()||(this.isFetching=e,this.$api.get("manager/guides/list",{next:this.next,count:this.perPage,filter:this.filter}).then(function(e){s.cachePage(e.response.guides),s.isFetching=!1}).catch(function(e){throw s.fields=[],s.total=0,s.isFetching=!1,e}))},onPageChange:function(e){this.page=e,this.fetchData()},clickRow:function(e){this.$form("vue-manager-guides-form",{guide_id:e.guide_id},this)}},template:'<div> <vue-component-filterbox @filter="onFilter" v-model="filter" :disabled="isFetching" :with-buttons="true"> <template slot="buttons"> <a @click="$form(\'vue-manager-guides-form\')" class="button is-primary is-fullwidth"><i class="fa fa-plus-circle"></i> Добавить инструкцию</a> </template> </vue-component-filterbox> <div class="container"> <div class="has-mb-2"> <b-table paginated backend-pagination pagination-simple :data="fields" :loading="isFetching" :per-page="perPage" :total="total" @page-change="onPageChange" @click="clickRow" hoverable bordered> <b-table-column field="title" label="Группа" class="has-width-20" v-slot="props"> {{props.row.guide_group_title}} </b-table-column> <b-table-column field="title" label="Загаловок" v-slot="props"> <div v-html="implode(props.row.titles)"></div> </b-table-column> <template slot="empty"> <section class="has-mb-4 has-mt-4 content has-text-grey has-text-centered" v-if="!isFetching"> <p><b-icon icon="frown" size="is-large"></b-icon></p> <p>{{\'Пока ничего нет\'|gettext}}</p> </section> <section class="has-mb-4 has-mt-4 content has-text-grey has-text-centered" v-if="isFetching"> <p>{{\'Загрузка данных\'|gettext}}</p> </section> </template> </b-table> </div> </div> </div>'}),window.$app.defineComponent("manager","vue-manager-locales-index",{props:["current"],created:function(){var t=this;this.current||this.$api.get("manager/locales/current").then(function(e){t.$router.replace({name:"manager.locales",params:{current:e.response.current}})})},template:"<router-view></router-view>"}),window.$app.defineComponent("manager","vue-manager-locales",{data:function(){return{search:"",locales:null,phrases:null,phrases_base:null,base:[],languages:[],currentNode:null,addons:null,payments:null,amount_need:0,isFetching:!1,isUpdating:!1,filter:"",filters:null,baseLanguage:!1}},mixins:[FormModel],props:["current"],watch:{current:function(){this.currentNode=null,this.fetchData()}},created:function(){this.fetchData()},computed:{currentNodePhrases:function(){var t=this;return this.search?_.filter(this.phrases,function(e){return t.baseLanguage&&"en"!=t.current&&null!=t.base[e.k]?-1!=t.base[e.k].toLowerCase().indexOf(t.search.toLowerCase()):-1!=e.k.toLowerCase().indexOf(t.search.toLowerCase())}):null==this.currentNode?null:null==this.currentNode.messages?this.currentNode.phrases:_.filter(this.phrases,function(e){return null!=t.currentNode.messages[e.k]})},filteredNodes:function(){return this.locales}},methods:{filterNodes:function(e){return e},onPageChange:function(e){this.page=e,this.fetchData()},onSort:function(e,t){this.sortField=e,this.sortOrder=t,this.fetchData()},fetchData:function(){var t=this;this.isFetching=!0,this.$api.get("manager/locales/get",{language:this.current}).then(function(e){t.baseLanguage=e.response.locales.language_base,t.phrases=e.response.locales.phrases,t.phrases_base=e.response.locales.phrases_base,t.locales=e.response.locales.locales,t.languages=e.response.locales.languages,t.addons=e.response.locales.addons,t.payments=e.response.locales.payments,t.selectNode(t.locales.nodes[Object.keys(t.locales.nodes)[0]],t.phrases_base),t.isFetching=!1}).catch(function(e){throw t.locales=[],e})},selectNode:function(e,t){if(null!=e&&null!=e.messages)for(;0==e.messages.length;)e=e.nodes[Object.keys(e.nodes)[0]];this.currentNode=e,this.base=t},updateData:function(){var t=this;this.isUpdating=!0,this.$api.post("manager/locales/set",{phrases:this.phrases,language:this.current,addons:this.addons,payments:this.payments},this).then(function(e){t.isUpdating=!1})},hits:function(e){var t=0;if(null==e.messages)for(i in e.phrases)t+=""==e.phrases[i].v?1:0;else for(i in e.messages)t+=""==this.phrases[i].v?1:0;return t},getInputType:function(e){return""==e.v?"is-danger":""},changeLanguage:function(){this.$router.replace({name:"manager.locales",params:{current:this.current}})},changeFilter:function(){},openExportForm:function(){this.$form("vue-manager-locales-export-form",{current:this.current},this)},openImportForm:function(){this.$form("vue-manager-locales-import-form",{phrases:this.phrases,languages:this.languages},this)}},template:'<div class="has-p-2 has-mb-2 has-mt-1"> <div class="container is-mb-4" v-if="amount_need"> <b-notification type="is-danger has-mb-2" :closable="false"> Messages without translate: {{ amount_need }} </b-notification> </div> <div class="row row-small"> <div class="col-sm-3"> <div class="media"> <div class="media-content"> <b-select v-model="current" expanded @input="changeLanguage"> <option :value="k" v-for="(v, k) in languages">{{v}}</option> </b-select> </div> <mx-toggle v-model="baseLanguage" trueValue="EN" falseValue="RU" class="is-pulled-right has-ml-2" :disabled="current == \'en\'"></mx-toggle> </div> </div> <div class="col-xs"> <input type="text" v-model="search" class="input is-fullwidth" :placeholder="\'Поиск\'|gettext"> </div> <div class="col-xs col-shrink" style="width:60px"> <a @click="openExportForm" class="button is-light is-fullwidth" v-tippy :content="\'Скачать в формате CSV\'|gettext"><i class="fa fas fa-download"></i></a> </div> <div class="col-sm-2"> <button class="button is-primary is-fullwidth" @click="updateData" :class="{\'is-loading\': isUpdating}" :disabled="isFetching">{{\'Сохранить изменения\'|gettext}}</button> </div> </div> <hr class="is-hidden-mobile"> <div class="row"> <div class="col-sm-3"> <aside class="menu-locales" style="padding-bottom: 2rem" v-if="locales" :class="{disabled: search}" :style="{opacity: search?\'.1 !important\':1}"> <ul class="menu-list"> <li v-for="(v, i) in this.filteredNodes.nodes"> <a class="is-block" @click="selectNode(v, phrases_base)" :class="{\'is-active\': currentNode== v}">{{i}} <span class="tag is-rounded is-danger" v-if="hits(v)">{{hits(v)}}</span></a> <ul v-if="v.nodes"> <li v-for="(w, j) in v.nodes"><a class="is-block" @click="selectNode(w, phrases_base)" :class="{\'is-active\': currentNode== w}">{{j}} <span class="tag is-rounded is-danger" v-if="hits(w)">{{hits(w)}}</span></a> <ul v-if="w.nodes"> <li v-for="(ww, jj) in w.nodes"><a class="is-block" @click="selectNode(ww, phrases_base)" :class="{\'is-active\': currentNode== ww}">{{jj}} <span class="tag is-rounded is-danger" v-if="hits(ww)">{{hits(ww)}}</span></a> </li> </ul> </li> </ul> </li> <li><a class="is-block" @click="selectNode(payments[0], payments[0].phrases_base)">Payments</a> <ul> <li v-for="p in payments"> <a class="is-block" @click="selectNode(p, p.phrases_base)" :class="{\'is-active\': currentNode== p}">{{p.title}} <span class="tag is-rounded is-danger" v-if="hits(p)">{{hits(p)}}</span></a></li> </ul> </li> <li><a class="is-block" @click="selectNode(addons[0], addons[0].phrases_base)">Addons</a> <ul> <li v-for="p in addons"><a class="is-block" @click="selectNode(p, p.phrases_base)" :class="{\'is-active\': currentNode== p}">{{p.title}} <span class="tag is-rounded is-danger" v-if="hits(p)">{{hits(p)}}</span></a></li> </ul> </li> </ul> </aside> </div> <div class="col-sm-9"> <div v-if="currentNode && currentNode.type == \'addon\'"> <div class="field"> <label class="label">Title</label> <input type="text" class="input" v-model="currentNode.addon_title"> </div> <div class="field"> <label class="label">Snippet</label> <textarea type="text" class="input" v-model="currentNode.addon_snippet"></textarea> </div> <hr class="is-hidden-mobile"> </div> <b-table :data="currentNodePhrases" :loading="isFetching" bordered v-if="currentNode"> <b-table-column field="k" width="200" label="Phrase" v-slot="props"> <div class="control is-fullwidth"><input :value="(baseLanguage && current != \'en\' && (base[props.row.k] != undefined))?base[props.row.k]:props.row.k" class="input" disabled></div> </b-table-column> <b-table-column field="v" width="200" label="Translate" v-slot="props"> <b-field :type="getInputType(props.row)"><b-input v-model="props.row.v" class="is-fullwidth"></b-input></b-field> </b-table-column> </b-table> </div> </div> <b-loading :is-full-page="false" :active.sync="isFetching"></b-loading> </div>'}),window.$app.defineComponent("manager","vue-manager-locales-export-form",{data:function(){return{isUpdating:!1,isRefreshing:!1,isFetching:!1,amount:0,charset:"utf-8",filter:"*",variants:{}}},props:["current"],created:function(){this.fetchData(!0)},computed:{downloadUrl:function(){return"/api/manager/locales/export/download.csv?filter="+this.filter+"&charset="+this.charset+"&current="+this.current}},mixins:[FormModel],methods:{fetchData:function(e){var t=this;this.isRefreshing=this.isFetching=e,this.$api.get("manager/locales/export/info").then(function(e){t.isFetching=t.isRefreshing=!1,t.variants=e.response.export.info.variants})}},template:'<div class="modal-card"> <header class="modal-card-head"> <p class="modal-card-title">{{\'Экспорт фраз\'|gettext}}</p> <button class="modal-close is-large" @click="$parent.close()"></button> </header> <section class="modal-card-body"> <b-field :label="\'Фильтр\'|gettext"> <b-select v-model="filter" expanded> <option value="*">Выгрузить все</option> <option :value="k" v-for="(v, k) in variants.filters">Исключая "{{k}}"</option> </b-select> </b-field> <b-field :label="\'Кодировка\'|gettext"> <b-select v-model="charset" expanded> <option v-for="(v, k) in variants.charset" :value="k">{{ v }}</option> </b-select> </b-field> </section> <footer class="modal-card-foot"> <a :href="downloadUrl" target="frame" class="button is-success is-pulled-right no-ajax" :class="{\'is-loading\': isRefreshing}"><span class="is-hidden-mobile">{{\'Скачать CSV-файл\'|gettext}}</span><span class="is-hidden-tablet">{{\'Скачать\'|gettext}}</span></a> <button class="button is-dark" type="button" @click="$parent.close()">{{\'Закрыть\'|gettext}}</button> </footer> <b-loading :is-full-page="false" :active.sync="isFetching"></b-loading> </div>'}),window.$app.defineComponent("manager","vue-manager-locales-import-form",{data:function(){return{grid:null,data:null,isUpdating:!1,isFetching:!0,selects:[],columnSelect:null,values:{},is_done:!1,amount_updated:0,amount_notfound:0,current_language:"ru"}},props:["phrases","languages"],mounted:function(){var l=this;$mx.lazy("grid.js","grid.css",function(){var s={cols:2,rows:5,name:"data",clearPaste:"yes",autofocus:"yes"},t=$mx(l.$refs.grid),a=null,e=[],n=[];if(l.data&&null!=l.data.cells&&l.data.cells.length)n=s.data.cells,s.cols=Object.keys(n[0]).length;else for(i=1;i<=s.rows;i++)n.push({});for(i=1;i<=s.cols;i++)e.push({name:l.intToLetters(i),type:"string"});l.grid=t.grid(n,e),l.grid.registerEditor(BasicEditor),l.grid.render(),l.columns&&(l.columnSelect='<div class="select is-fullwidth"><select>'+_.map(l.columns,function(e){return'<option value="'+e.key+'">'+e.title+"</option>"})+"</select></div>",$mx("thead th div",t).html(l.columnSelect)),$mx.isset(s.data)&&$mx.isset(s.data.selects)&&s.data.selects.length&&$mx("thead th select",t).each(function(e,t){$mx(this).val(s.data.selects[e])}),s.name&&(a=$mx('<input type="hidden" name="'+s.name+'">').appendTo(t)),l.grid.events.on("editor:save",function(e){a&&(l.data={cells:l.grid.getGridData(),selects:$mx.makeArray($mx("select",t).map(function(){return this.value}))})}),l.grid.$el.on("change","select",function(){l.grid.events.trigger("editor:save")}),l.grid.events.trigger("editor:save"),l.grid.setActiveCell(cell=$mx("tbody tr:first td:first",l.grid.$el)),l.grid.$el.focus(),$mx(document).on("paste",l.paste),l.isFetching=!1})},destroyed:function(){$mx(document).off("paste",this.paste),this.grid.destroy()},mixins:[FormModel],methods:{updateData:function(){var s=this;"ru"==this.current_language?(_.each(this.data.cells,function(e){e.A=e.A.trim(),e.B=e.B.trim(),null==s.phrases[e.A]?(s.amount_notfound++,console.log(e.A)):(s.amount_updated++,s.phrases[e.A].v=e.B)}),this.is_done=!0):this.$api.get("manager/locales/get",{language:this.current_language}).then(function(e){var t={};_.each(e.response.locales.phrases,function(e){e.v&&(t[e.v]=e.k)}),_.each(s.data.cells,function(e){e.A=e.A.trim(),e.B=e.B.trim(),null!=t[e.A]&&null!=s.phrases[t[e.A]]?(s.amount_updated++,s.phrases[t[e.A]].v=e.B):(s.amount_notfound++,console.log(e.A))}),s.is_done=!0})},intToLetters:function(e){for(result="";0<=--e;)result=String.fromCharCode("A".charCodeAt(0)+e%26)+result,e/=26;return result},paste:function(e){if(this.grid.is(":focus")){var t=this.$refs.grid;oe=e.originalEvent;this.grid.setActiveCell(cell=$mx("tbody tr:first td:first",t)),$mx("tbody tr td:gt(0), thead tr th:gt(0)",t).remove(),$mx("tbody tr:gt(0)",t).remove();var s=cell.index(),a=function(){for(var e=window.clipboardData?window.clipboardData:oe.clipboardData,t=[],s=0;s<e.types.length;s++)t.push(e.types[s]);if(-1!=t.indexOf("text/html")&&(a=$mx(oe.clipboardData.getData("text/html"))).is("table"))return l=$mx("tr",a).map(function(){return[$mx("td",this).map(function(){return this.innerText}).get()]}).get();if(-1==t.indexOf("text/plain"))return[];var a,n=(a=oe.clipboardData.getData("text/plain")).split(/\r\n|\n|\r/),l=[];for(i=0;i<n.length;i++)l.push(n[i].split("\t"));return l}();for(i=0;i<a.length;i++){var n,l,o,r,c,d,p=a[i];if(p.length){for(j=0;j<p.length;j++){$mx("div",cell).text(p[j]),j<p.length-1&&(next=cell.next(),0==next.length&&(d=cell.closest("tr"),n=d.index(),l=d.closest("table"),o=$mx("thead tr",l),r=this.intToLetters($mx("th",o).length+1),c=0,$mx("tbody tr",l).each(function(){var e=$mx("<td><div></div></td>").appendTo(this).data(cell.data()).data("column",r);c==n&&(next=e),c++}),$mx("<th><div>"+(null!=this.columnSelect?this.columnSelect:r)+"</div></th>").appendTo(o)),cell=next)}i<a.length-1&&(d=cell.closest("tr"),next=d.next(),0==next.length&&(next=$mx(d[0].outerHTML),tdnext=$mx("td",next),c=0,$mx("td",d).each(function(){var e=$mx(this);$mx(tdnext[c]).data(e.data()),c++}),next.appendTo(d.parent()).removeClass("activeRow"),tdnext.removeClass("activeCell").find("div").empty()),cell=$mx(next.find("td")[s]))}}e.preventDefault(),this.grid.events.trigger("editor:save")}}},template:'<div class="modal-card modal-card-large"> <header class="modal-card-head"> <p class="modal-card-title">{{\'Загрузка языка из Excel\'|gettext}}</p> <button class="modal-close is-large" @click="$parent.close()"></button> </header> <section class="modal-card-body"> <div class="message is-success" v-if="is_done && amount_updated"><div class="message-body">Обновлено фраз: {{amount_updated|number}}</div></div> <div class="message is-danger" v-if="is_done && amount_notfound"><div class="message-body">Не найдено фраз: {{amount_notfound|number}}</div></div> <div v-else> <b-field label="Базовый язык"> <b-select v-model="current_language"> <option value="ru">Русский</option> <option :value="k" v-for="(v, k) in languages">{{v}}</option> </b-select> </b-field> <div ref="grid" class="has-mb-4"></div> <div class="block-arrow-left-top" style="margin-top: -15px;opacity:0.5"> Скопируйте нужные ячейки из Excel и вставьте в эту таблицу </div> </div> </section> <footer class="modal-card-foot"> <button class="button is-dark" type="button" @click="$parent.close()">{{\'Закрыть\'|gettext}}</button> <button v-if="!is_done" class="button is-primary" :class="{\'is-loading\': isUpdating}" @click="updateData">{{\'Загрузить\'|gettext}}</button> </footer> <b-loading :is-full-page="false" :active.sync="isFetching"></b-loading> </div>'}),window.$app.defineComponent("manager","vue-manager-logs-form",{data:function(){return{isUpdating:!1,isFetching:!1,values:{}}},created:function(){this.fetchData(!0)},props:["message_id"],mixins:[FormModel],methods:{fetchData:function(e){var t=this;this.isFetching=e,this.$api.get("manager/logs/get",{message_id:this.message_id}).then(function(e){t.isFetching=!1,t.values=e.response.logs.message,t.values.message=JSON.stringify(t.values.message,null,"\t")})}},template:'<div class="modal-card modal-card-large"> <header class="modal-card-head"> <p class="modal-card-title">Событие</p> <button class="modal-close is-large" @click="$parent.close()"></button> </header> <section class="modal-card-body"> <vue-component-codemirror v-model="values.message" mode="application/json" readonly="true"></vue-component-codemirror> </section> <footer class="modal-card-foot"> <button class="button is-dark" type="button" @click="$parent.close()">{{\'Закрыть\'|gettext}}</button> </footer> <b-loading :is-full-page="false" :active.sync="isFetching"></b-loading> </div>'}),window.$app.defineComponent("manager","vue-manager-logs-list",{data:function(){return{isFetching:!1,filter:{query:"",tags:[]},perPage:100,filterTags:["owner_id","service_name"]}},mixins:[ListModel],created:function(){this.fetchData(!0)},methods:{onFilter:function(){this.clearPages(),this.fetchData(!0)},refresh:function(){this.fetchData(!1,!0)},fetchData:function(e,t){var s=this;!t&&this.checkCache()||(this.isFetching=e,this.$api.get("manager/logs/list",{next:this.next,count:this.perPage,filter:this.filter}).then(function(e){s.cachePage(e.response.logs),s.isFetching=!1}).catch(function(e){throw s.fields=[],s.total=0,s.isFetching=!1,e}))},tagsFetch:function(e,t,s){0<=["owner_id"].indexOf(e)?s([]):this.$api.get("manager/logs/filters",{query:t,name:e}).then(function(e){s("success"==e.result?e.response.variants:[])})},onPageChange:function(e){this.page=e,this.fetchData()},clickRow:function(e){this.$form("vue-manager-logs-form",{message_id:e.message_id},this)}},template:'<div> <vue-component-filterbox @filter="onFilter" :tags-fetch="tagsFetch" :allow-tags="filterTags" v-model="filter" :disabled="isFetching"></vue-component-filterbox> <div class="container"> <div class="has-mb-2"> <b-table paginated backend-pagination pagination-simple :data="fields" :loading="isFetching" :per-page="perPage" :total="total" @page-change="onPageChange" @click="clickRow" hoverable bordered> <b-table-column field="post_id" label="" class="has-width-5 has-text-grey" v-slot="props">{{ props.row.message_id }}</b-table-column> <b-table-column field="service_name" label="Сервис" v-slot="props"> {{ props.row.service_name }} </b-table-column> <b-table-column field="code" label="HTTP Code" class="has-width-5" v-slot="props"> <span :class="{\'has-text-success\': props.row.code>= 200 && props.row.code < 300, \'has-text-danger\': props.row.code>= 400}">{{ props.row.code }}</span> </b-table-column> <b-table-column field="owner" label="Профиль" v-slot="props"> <span v-if="props.row.owner">{{ props.row.owner }}</span> </b-table-column> <b-table-column field="tms_created" label="Дата" numeric v-slot="props"> {{ props.row.tms|datetime }} </b-table-column> <template slot="empty"> <section class="has-mb-4 has-mt-4 content has-text-grey has-text-centered" v-if="!isFetching"> <p><b-icon icon="frown" size="is-large"></b-icon></p> <p>{{\'Пока ничего нет\'|gettext}}</p> </section> <section class="has-mb-4 has-mt-4 content has-text-grey has-text-centered" v-if="isFetching"> <p>{{\'Загрузка данных\'|gettext}}</p> </section> </template> </b-table> </div> </div> </div>'}),window.$app.defineComponent("manager","vue-manager-mails-campaings-form",{data:function(){return{values:null,variant_idx:0,variants:{sender_id:null},view:"view",errors:{},isFetching:!1,isUpdating:!1,domain:"taplink.cc",activeTab:"common",isFetchingTags:!1,autocompleteTags:[],styles:""}},mixins:[FormModel],props:["campaing_id"],components:{vRuntimeTemplate:vRuntimeTemplate},watch:{view:function(e){"html"==e&&this.autoFormat()},variant_idx:function(){"html"==this.view&&this.autoFormat()}},mounted:function(){this.fetchData(!0)},computed:{template:function(){var e=this.send;if(!e)return"";var t=e.template_id?this.variants.template_id[e.template_id].template:"<div>{{body}}</div>",s=new RegExp("<style>.*?</style>","igsm"),a=s.exec(t);return this.styles=a?a[0]:"",t.replace(s,"").replace("{{body}}",'<vue-component-editor class="editor" v-model="send.body" block-tag="DIV"></vue-component-editor>')},defaultSendername:function(){return this.values&&this.values.sender_id&&this.variants&&this.variants.sender_id?this.variants.sender_id[this.values.sender_id].name:""},send:function(){return this.variant_idx<this.values.sends.length?this.values.sends[this.variant_idx]:null}},methods:{onAction:function(e){var t=this;switch(e){case"test":this.save(function(){t.$prompt("На какую почту отправить письмо?",{value:t.$account.user.email}).then(function(e){t.$api.post("manager/mails/campaings/test",{campaing_id:t.campaing_id,email:e},t).then(function(e){"success"==e.result&&t.$toast("Письмо успешно отправленно","is-success")})})});break;case"archive":this.onArchive()}},onAddingTag:function(e){return!_.find(this.values.tags,["tag_id",e.tag_id])},onAddedTag:function(e){"string"==typeof e&&(this.values.tags.pop(),this.values.tags.push({tag_id:null,tag:e}))},asyncAutocompleteTag:_.debounce(function(e){var t=this;""!=e.trim()?(this.isFetchingCollections=!0,this.$api.get("manager/mails/campaings/tags",{query:e}).then(function(e){t.autocompleteTags=_.differenceWith(e.response.tags,t.value,function(e,t){return e.tag_id==t.tag_id}),t.isFetchingTags=!1})):this.autocompleteCollections=[]},300),onArchive:function(){var t=this;this.$confirm("Вы уверены что хотите отправить эту компанию в архив?","is-warning").then(function(){t.$api.post("manager/mails/campaings/archive",{campaing_id:t.campaing_id},t).then(function(e){"success"==e.result&&t.$parent.close()})})},autoFormat:function(){var e=this;this.$nextTick(function(){null!=e.$refs.code&&e.$refs.code.autoFormat()})},prepareHTML:function(e){return(e.template_id&&null!=this.variants.template_id&&null!=this.variants.template_id[e.template_id]?this.variants.template_id[e.template_id].template:"<div>{{body}}</div>").replace("{{body}}",e.body)},fetchData:function(e){var s=this;this.isFetching=e,this.$api.get(this.campaing_id?["manager/mails/campaings/get","manager/mails/campaings/variants"]:"manager/mails/campaings/variants",{campaing_id:this.campaing_id}).then(function(e){var t;s.variants=e.response.campaings.variants,s.campaing_id?(t=e.response.campaings.values,s.values=t):(s.values={campaing_id:null,campaing_title:"",sender_id:null,sends:[],tags:[]},s.addVariant()),s.isFetching=!1})},updateData:function(){var e=this;this.save(function(){e.$parent.close()})},save:function(t){var s=this;this.isUpdating=!0;var e=Object.assign({campaing_id:this.campaing_id},this.values);e.tags=_.map(e.tags,"tag"),this.$api.post("manager/mails/campaings/set",e,this).then(function(e){s.isUpdating=!1,"success"==e.result&&t()}).catch(function(){s.isUpdating=!1})},addVariant:function(){var e=1,t="",s="<div></div>";this.values.sends.length&&this.values.sends[0].template_id&&(e=this.values.sends[0].template_id,t=this.variants.template_id[e].template,s=this.variants.template_id[e].sample);var a={send_id:null,subject:"",sender_name:"",variants:"",template_id:e,template:t,body:s,text:""};a.html=this.prepareHTML(a),this.values.sends.push(a),this.variant_idx=this.values.sends.length-1},deleteVariant:function(e){var t=this;this.$confirm(this.$gettext("Вы уверены что хотите удалить этот вариант?"),"is-danger").then(function(){e==t.variant_idx&&(t.variant_idx=0),t.values.sends.splice(e,1),t.variant_idx>e&&t.variant_idx--})},updateBody:function(){var e=this.values.sends[this.variant_idx],t=this.prepareHTML(e);e.html!=t&&(e.html=t)},chooseTemplate:function(){var e=this.values.sends[this.variant_idx];e.template=this.variants.template_id[e.template_id].template,this.updateBody()}},template:'<form class="modal-card modal-card-large" @submit.prevent="updateData"> <header class="modal-card-head"> <p class="modal-card-title">Рассылка</p> <button class="modal-close is-large" type="button" @click="$parent.close()"></button> </header> <ul class="nav nav-tabs has-text-left"> <li :class="{active: activeTab== \'common\'}"><a @click="activeTab = \'common\'">{{\'Общие\'|gettext}}</a></li> <li :class="{active: activeTab== \'options\'}"><a @click="activeTab = \'options\'">{{\'Дополнительно\'|gettext}}</a></li> </ul> <section class="modal-card-body modal-card-body-blocks" v-if="values"> <section v-if="activeTab == \'common\'"> <div class="row row-small"> <div class="col-xs-12 col-sm-6"> <label class="label">Название рассылки</label> <b-input type="text" v-model="values.campaing_title"></b-input> </div> <div class="col-xs-12 col-sm-6"> <label class="label">Отправитель</label> <b-select placeholder="-- Не выбран --" v-model="values.sender_id" expanded> <option v-for="f in variants.sender_id" :value="f.sender_id" :key="f.sender_id">{{f.fullname}}</option> </b-select> </div> </div> </section> <section v-if="activeTab == \'common\'"> <div class="level has-mb-1"> <div class="level-left"> <label class="label">Варианты</label> </div> <div class="level-right"> <a @click="addVariant">Добавить</a> </div> </div> <div v-for="(v, i) in values.sends"> <div class="field has-addons" :class="{\'has-mb-2\': values.sends.length> 1 && i < values.sends.length - 1}"> <p class="control"> <a class="button is-static1"> <input type="radio" v-model="variant_idx" :value="i"> </a> </p> <p class="control is-expanded"> <b-taginput v-model="v.variants" attached></b-taginput> </p> <p class="control"> <p class="button" :class="{\'is-static\': values.sends.length == 1}"> <a @click="deleteVariant(i)" :class="{\'has-text-danger\': values.sends.length> 1, \'has-text-grey-light\': values.sends.length == 1}"><i class="fa fa-trash-alt"></i></a> </p> </p> </div> </div> </section> <section v-if="activeTab == \'common\' && send"> <div class="row row-small"> <div class="col-xs-12 col-sm-6"> <label class="label">Заголовок письма</label> <b-input type="text" v-model="send.subject"></b-input> </div> <div class="col-xs-12 col-sm-6"> <label class="label">Имя отправителя</label> <b-input type="text" v-model="send.sender_name" :placeholder="defaultSendername"></b-input> </div> </div> </section> <section style="padding-bottom: 0" v-if="(activeTab == \'common\') && send"> <div style="padding: 0;display: flex"> <ul class="nav nav-tabs nav-tabs-scroll has-text-left" style="background: transparent;padding: 0"> <li :class="{\'active\': view== \'view\'}"><a @click="view = \'view\'">Просмотр</a></li> <li :class="{\'active\': view== \'html\'}"><a @click="view = \'html\'">HTML</a></li> <li :class="{\'active\': view== \'text\'}"><a @click="view = \'text\'">Текст</a></li> </ul> <b-dropdown v-if="view == \'view\'" v-model="send.template_id" aria-role="list" position="is-top-left" style="font-size:.9rem;align-self:center;flex-shrink:0"><label slot="trigger" aria-role="listitem">Шаблон: {{variants.template_id[send.template_id].template_title}}</label> <b-dropdown-item :value="id" v-for="(f, id) in variants.template_id">{{f.template_title}}</b-dropdown-item> </b-dropdown> </div> </section> <section style="padding:0" v-if="(activeTab == \'common\') && send"> <div v-if="!isFetching && view== \'view\'" class="email-editor" :data-template="send.template_id"> <v-runtime-template :template="template"></v-runtime-template> <div v-html="styles"></div> </div> <vue-component-codemirror v-if="view == \'html\'" v-model="send.body" ref="code" :auto-height="true"></vue-component-codemirror> </section> <section v-if="(view == \'text\') && (activeTab == \'common\') && send"> <vue-component-emoji-picker v-model="send.text"> <textarea class="input autoresize-init" :placeholder="\'Текст\'|gettext" v-emoji v-model="send.text" style="min-height: 400px"></textarea> </vue-component-emoji-picker> </section> <section v-if="activeTab == \'options\'"> <b-field :label="\'Метки\'|gettext"> <b-taginput v-model="values.tags" :data="autocompleteTags" :before-adding="onAddingTag" @add="onAddedTag" :allow-new="true" confirm-key-codes=\'[13]\' autocomplete field="tag" @typing="asyncAutocompleteTag" placeholder="Укажите метки" :loading="isFetchingTags" attached> <template slot-scope="props"> <strong>{{props.option.tag}}</strong> </template> <template slot="empty"> <div v-if="isFetchingTags">{{\'Идет загрузка\'|gettext}}</div> <div v-else>{{\'Ничего не найдено\'|gettext}}</div> </template> </b-taginput> </b-field> </section> </section> <footer class="modal-card-foot level"> <div class="level-left"> <vue-component-action-button @action="onAction" :title="\'Действие\'|gettext"> <template slot="actions"> <b-dropdown-item value="test"><i class="fa fa-paper-plane"></i> {{\'Отправить тестовое письмо\'|gettext}}</b-dropdown-item> <b-dropdown-item value="archive"><i class="fa fa-archive"></i> {{\'В архив\'|gettext}}</b-dropdown-item> </template> </vue-component-action-button> </div> <div class="level-right"> <button class="button is-primary level-item" type="submit" :class="{\'is-loading\': isUpdating}">{{\'Сохранить\'|gettext}}</button> </div> </footer> <b-loading :is-full-page="false" :active.sync="isFetching"></b-loading> </form>'}),window.$app.defineComponent("manager","vue-manager-mails-campaings-list",{data:function(){return{isFetching:!1,filter:{query:"",tags:[]},columns:null,filterTags:["archive"]}},props:["page_id"],created:function(){this.$io.on("events:manager.mails.campaings.list:refresh",this.refresh)},mounted:function(){this.fetchData(!0)},beforeDestroy:function(){this.$io.off("events:manager.mails.campaings.list:refresh",this.refresh)},methods:{tagsFetch:function(e,t,s){0<=["archive"].indexOf(e)&&s([])},newForm:function(){this.$form("vue-manager-mails-campaings-form",{campaing_id:null},this)},onFilter:function(){this.clearPages(),this.fetchData(!0)},refresh:function(){this.fetchData(!1,!0)},fetchData:function(e,t){var s=this;!t&&this.$refs.list.checkCache()||(this.isFetching=e,this.$api.get(this.columns?"manager/mails/campaings/list":["manager/mails/campaings/list","manager/mails/campaings/info"],{next:this.$refs.list.next,count:this.$refs.list.perPage,filter:this.filter}).then(function(e){var t=e.response.campaings;s.$refs.list.cachePage(t.list),null!=t.info&&null!=t.info.columns&&(s.columns=t.info.columns),s.isFetching=!1}).catch(function(e){throw s.fields=[],s.total=0,s.isFetching=!1,e}))}},template:'<div> <vue-component-submenu menu="manager.mails" :page_id="page_id"></vue-component-submenu> <vue-component-filterbox ref="filterbox" @filter="onFilter" v-model="filter" :tags-fetch="tagsFetch" :allow-tags="filterTags" :with-buttons="true"> <template slot="buttons"> <a @click="newForm" class="button is-primary is-fullwidth"><i class=\'fas fa-plus\'></i><span class=\'is-hidden-touch has-ml-1\'>{{\'Новая рассылка\'|gettext}} </span></a> </template> </vue-component-filterbox> <div class="container"> <div class="has-mb-2"> <vue-manager-mails-campaings-table ref=\'list\' :columns="columns" :isFetching.sync="isFetching" @fetch-data="fetchData"></vue-manager-mails-campaings-table> </div> </div> </div>'}),window.$app.defineComponent("manager","vue-manager-mails-campaings-table",{data:function(){return{perPage:50}},props:["columns","isFetching"],mixins:[ListModel],computed:{columns_props:function(){if(!this.columns)return[];for(var s={campaing_title:{label:"Название",classname:"has-text-nowrap",sortable:!0},amount_sent:{label:"Доставленно",classname:"has-width-15",sortable:!0,numeric:!0},amount_bounced:{label:"Ошибки",classname:"has-width-15",sortable:!0,numeric:!0},amount_opened:{label:"Открыли",classname:"has-width-15",sortable:!0,numeric:!0},amount_clicked:{label:"Кликнули",classname:"has-width-15",sortable:!0,numeric:!0}},e=_.map(this.columns,function(e){var t=s[e];return t.visible=!0,t.field=e,t}),t=0;t<11-this.columns.length;t++)e.push({visible:!1});return e[0].classname+=" has-text-nowrap",e}},methods:{fetchData:function(e,t){this.$emit("fetch-data",[e,t])},clickRow:function(e){this.$form("vue-manager-mails-campaings-form",{campaing_id:e.campaing_id},this)},sentrate:function(e){return Math.min(e.amount_sent+e.amount_bounced?Math.round(e.amount_sent/(e.amount_sent+e.amount_bounced)*1e4)/100:0,100)},bouncedrate:function(e){return Math.min(e.amount_sent+e.amount_bounced?Math.round(e.amount_bounced/(e.amount_sent+e.amount_bounced)*1e4)/100:0,100)},openrate:function(e){return Math.min(e.amount_sent?Math.round(e.amount_opened/e.amount_sent*1e4)/100:0,100)},clickrate:function(e){return Math.min(e.amount_opened?Math.round(e.amount_clicked/e.amount_opened*1e4)/100:0,100)}},template:'<div> <b-table paginated backend-pagination pagination-simple :data="fields" :loading="isFetching" :current-page="page" :per-page="perPage" :total="total" @page-change="onPageChange" hoverable bordered @click="clickRow"> <b-table-column v-for="(column, index) in columns_props" :field="column.field" :label="column.label|gettext" :cell-class="[\'td-progress\', column.classname]" :numeric="column.numeric" :key="index" :visible="column.visible" :sortable="column.sortable" :width="column.width" v-slot="props"> <span v-if="column.field == \'campaing_title\'"> {{ props.row.campaing_title }} <div class="tags" class="tags is-pulled-right" v-if="_.size(props.row.tags)"><span class="tag is-light" v-for="c in props.row.tags">{{c}}</span></div> </span> <span v-if="column.field == \'amount_sent\'"> <div class="td-progress-value has-background-info" :style="{\'width\': sentrate(props.row)+\'%\'}"></div> <div class="td-progress-body"> <div class="is-pulled-right">{{props.row.amount_sent|number}}</div> <span class="has-text-grey">{{sentrate(props.row)|number(2)}}%</span> </div> </span> <span v-if="column.field == \'amount_bounced\'"> <div class="td-progress-value has-background-danger" :style="{\'width\': bouncedrate(props.row)+\'%\'}"></div> <div class="td-progress-body"> <div class="is-pulled-right">{{props.row.amount_bounced|number}}</div> <span class="has-text-grey">{{bouncedrate(props.row)|number(2)}}%</span> </div> </span> <span v-if="column.field == \'amount_opened\'"> <div class="td-progress-value has-background-warning" :style="{\'width\': openrate(props.row)+\'%\'}"></div> <div class="td-progress-body"> <div class="is-pulled-right">{{props.row.amount_opened|number}}</div> <span class="has-text-grey">{{openrate(props.row)|number(2)}}%</span> </div> </span> <span v-if="column.field == \'amount_clicked\'"> <div class="td-progress-value has-background-success" :style="{\'width\': clickrate(props.row)+\'%\'}"></div> <div class="td-progress-body"> <div class="is-pulled-right">{{props.row.amount_clicked|number}}</div> <span class="has-text-grey">{{clickrate(props.row)|number(2)}}%</span> </div> </span> </b-table-column> <template slot="empty"> <section class="has-mb-4 has-mt-4 content has-text-grey has-text-centered" v-if="!isFetching"> <p><b-icon icon="frown" size="is-large"></b-icon></p> <p>{{\'Пока ничего нет\'|gettext}}</p> </section> <section class="has-mb-4 has-mt-4 content has-text-grey has-text-centered" v-if="isFetching"> <p>{{\'Загрузка данных\'|gettext}}</p> </section> </template> </b-table> </div>'}),window.$app.defineComponent("manager","vue-manager-mails-messages-list",{data:function(){return{isFetching:!1,filter:{query:"",tags:[]},statistics:null,perPage:100,filterTags:["campaing"]}},props:["page_id"],mixins:[ListModel],created:function(){this.fetchData(!0),this.fetchStatistics()},methods:{onFilter:function(){this.clearPages(),this.fetchData(!0)},fetchStatistics:function(){var t=this;this.statistics=null,this.$api.get("manager/mails/messages/statistics").then(function(e){"success"==e.result&&(t.statistics=e.response.statistics)})},fetchData:function(e,t){var s=this;!t&&this.checkCache()||(this.isFetching=e,this.$api.get("manager/mails/messages/list",{next:this.next,count:this.perPage,filter:this.filter}).then(function(e){s.cachePage(e.response.messages),s.isFetching=!1}).catch(function(e){throw s.fields=[],s.total=0,s.isFetching=!1,e}))},tagsFetch:function(e,t,s){0<=["campaing"].indexOf(e)?s([]):this.$api.get("manager/mails/messages/filters",{query:t,name:e}).then(function(e){s("success"==e.result?e.response.variants:[])})}},template:'<div> <vue-component-submenu menu="manager.mails" :page_id="page_id"></vue-component-submenu> <div class="container has-mb-2 has-mt-2"> <div v-for="stat in statistics"> <div style="display: flex;flex-direction: row"> <div class="has-background-grey-light profiles-conversion-bar" style="flex-grow: 1"> <div :data-stage="s.stage" v-tippy :style="{width: s.percent}" :content="s.message_status" v-for="s in stat"><span>{{s.title}}</span></div> </div> </div> </div> </div> <vue-component-filterbox @filter="onFilter" :tags-fetch="tagsFetch" :allow-tags="filterTags" v-model="filter" :disabled="isFetching"></vue-component-filterbox> <div class="container"> <div class="has-mb-2"> <b-table paginated backend-pagination pagination-simple :data="fields" :loading="isFetching" :per-page="perPage" :total="total" @page-change="onPageChange" hoverable bordered> <b-table-column field="post_id" label="ID" class="has-width-5 has-text-grey" v-slot="props">{{ props.row.message_id }}</b-table-column> <b-table-column field="service_name" label="Адрес" v-slot="props">{{ props.row.address }}</b-table-column> <b-table-column :label="\'Дата\'|gettext" v-slot="props">{{ props.row.tms_created|datetime }}</b-table-column> <b-table-column :label="\'Заголовок\'|gettext" v-slot="props">{{ props.row.subject }}</b-table-column> <b-table-column :label="\'Статус\'|gettext" v-slot="props"> <div :class="\'has-text-\'+props.row.message_status_classname"> <span v-if="props.row.message_status_id == 4" class="has-text-danger is-pulled-right" v-tippy :content="props.row.reason"><i class="fal fa-exclamation-triangle"></i></span> {{ props.row.message_status|gettext }} </div> </b-table-column> <template slot="empty"> <section class="has-mb-4 has-mt-4 content has-text-grey has-text-centered" v-if="!isFetching"> <p><b-icon icon="frown" size="is-large"></b-icon></p> <p>{{\'Пока ничего нет\'|gettext}}</p> </section> <section class="has-mb-4 has-mt-4 content has-text-grey has-text-centered" v-if="isFetching"> <p>{{\'Загрузка данных\'|gettext}}</p> </section> </template> </b-table> </div> </div> </div>'}),window.$app.defineComponent("manager","vue-manager-mails-sequences-list",{data:function(){return{isFetching:!1,sequence:null,perPage:100,filter:{query:"",tags:[]},columns:null,columnsItems:null,filterTags:["archive"]}},props:["page_id"],mixins:[ListModel],created:function(){this.$io.on("events:manager.mails.sequences.list:refresh",this.refresh),this.fetchData(!0)},beforeDestroy:function(){this.$io.off("events:manager.mails.sequences.list:refresh",this.refresh)},computed:{columns_props:function(){if(!this.columns)return[];for(var s={sequence_title:{label:"Название",classname:"has-text-nowrap",sortable:!0}},e=_.map(this.columns,function(e){var t=s[e];return t.visible=!0,t.field=e,t}),t=0;t<11-this.columns.length;t++)e.push({visible:!1});return e[0].classname+=" has-text-nowrap",e}},methods:{tagsFetch:function(e,t,s){s([])},onFilter:function(){this.clearPages(),this.fetchData(!0)},refresh:function(){this.fetchData(!1,!0)},clickRow:function(e){this.sequence=e,this.$refs.list.clearPages(),this.$refs.list.fields=[],this.fetchDataItems(!0,!0)},fetchData:function(e,t){var s=this;!t&&this.checkCache()||(this.isFetching=e,this.$api.get(this.columns?"manager/mails/sequences/list":["manager/mails/sequences/list","manager/mails/sequences/info"],{next:this.next,count:this.perPage,filter:this.filter}).then(function(e){var t=e.response.sequences;s.cachePage(t.list),null!=t.info&&null!=t.info.columns&&(s.columns=t.info.columns),s.isFetching=!1}).catch(function(e){throw s.fields=[],s.total=0,s.isFetching=!1,e}))},fetchDataItems:function(e,t){var s=this;!t&&this.$refs.list.checkCache()||(this.isFetching=e,this.$api.get(this.columnsItems?"manager/mails/campaings/list":["manager/mails/campaings/list","manager/mails/campaings/info"],{next:this.$refs.list.next,count:this.$refs.list.perPage,sequence_id:this.sequence.sequence_id}).then(function(e){var t=e.response.campaings;s.$refs.list.cachePage(t.list),null!=t.info&&null!=t.info.columns&&(s.columnsItems=t.info.columns),s.isFetching=!1}).catch(function(e){throw s.fields=[],s.total=0,s.isFetching=!1,e}))}},template:'<div> <vue-component-submenu menu="manager.mails" :page_id="page_id"></vue-component-submenu> <vue-component-filterbox ref="filterbox" @filter="onFilter" v-model="filter" :tags-fetch="tagsFetch" :allow-tags="filterTags" :with-buttons="true" v-if="!sequence"> <template slot="buttons"> </template> </vue-component-filterbox> <div class="container"> <div class="has-mb-2"> <div v-if="sequence" class="panel panel-default has-mt-3 has-mb-3"> <div class="has-p-2 level"> <div class="level-left">{{sequence.sequence_title}}</div> <div class="level-right"><button class="button is-light" @click="sequence = null">К списку</button></div> </div> </div> <b-table paginated backend-pagination pagination-simple :data="fields" :loading="isFetching" :per-page="perPage" :total="total" @page-change="onPageChange" hoverable bordered @click="clickRow" v-else> <b-table-column v-for="(column, index) in columns_props" :field="column.field" :label="column.label|gettext" :numeric="column.numeric" :key="index" :visible="column.visible" :sortable="column.sortable" :width="column.width" v-slot="props"> <span v-if="column.field == \'sequence_title\'"> {{ props.row.sequence_title }} </span> </b-table-column> <template slot="empty"> <section class="has-mb-4 has-mt-4 content has-text-grey has-text-centered" v-if="!isFetching"> <p><b-icon icon="frown" size="is-large"></b-icon></p> <p>{{\'Пока ничего нет\'|gettext}}</p> </section> <section class="has-mb-4 has-mt-4 content has-text-grey has-text-centered" v-if="isFetching"> <p>{{\'Загрузка данных\'|gettext}}</p> </section> </template> </b-table> <vue-manager-mails-campaings-table ref=\'list\' :columns="columnsItems" :isFetching.sync="isFetching" @fetch-data="fetchDataItems" v-show="sequence"></vue-manager-mails-campaings-table> </div> </div> </div>'}),window.$app.defineComponent("manager","vue-manager-partners-agreements-form",{data:function(){return{isUpdating:!1,isFetching:!1,legalTypes:{entrepreneur:"ИП",company:"Компания"}}},created:function(){this.fetchData(!0)},props:["partner_id"],mixins:[FormModel],computed:{title:function(){return this.isFetching?"":this.legalTypes[this.values.details.legaltype]+" "+("company"==this.values.details.legaltype?'ООО "'+this.values.details.name+'"':this.values.details.f+" "+this.values.details.i+" "+this.values.details.o)}},methods:{agree:function(){var t=this;this.isUpdating=!0,this.$api.get("manager/partners/agreements/agree",{partner_id:this.partner_id}).then(function(e){"success"==e.result&&(t.values.agreement_status="signed"),t.isUpdating=!1})},fetchData:function(e){var t=this;this.isFetching=e,this.$api.get("manager/partners/agreements/get",{partner_id:this.partner_id}).then(function(e){t.isFetching=!1,t.values=e.response.values})},generate:function(){var t=this;this.isUpdating=!0,this.$api.get("manager/partners/agreements/generate",{partner_id:this.partner_id,number:this.values.agreement_number}).then(function(e){t.isUpdating=!1,t.values=e.response.values})}},template:'<div class="modal-card"> <header class="modal-card-head"> <p class="modal-card-title">Договор</p> <button class="modal-close is-large" @click="$parent.close()"></button> </header> <section class="modal-card-body"> <div class="has-mb-2">{{title}}</div> <div class="has-mb-2" v-if="values.details">Почта: {{values.details.email}} <vue-component-clipboard :text="values.details.email"/></div> <div class="has-mb-2" v-if="values.details">ИНН: {{values.details.inn}} <vue-component-clipboard :text="values.details.inn"/></div> <div v-if="values.agreement_number"> <a :href="\'https://docs.google.com/gview?url=http://p1.taplink.ru/c/agreements/\'+values.agreement_number+\'.docx\'" target="_blank" class="button is-dark">Открыть документ</a> <button class="button is-primary" :class="{\'is-loading\': isUpdating}" @click="generate">Пересоздать документ</button> <button class="button is-success" :class="{\'is-loading\': isUpdating}" @click="agree" v-if="values.agreement_status != \'signed\'">Подтвердить договор</button> </div> <button v-else class="button is-primary" :class="{\'is-loading\': isUpdating}" @click="generate">Сгенерировать документ</button> </section> <footer class="modal-card-foot"> <button class="button is-dark" type="button" @click="$parent.close()">{{\'Закрыть\'|gettext}}</button> </footer> <b-loading :is-full-page="false" :active.sync="isFetching"></b-loading> </div>'}),window.$app.defineComponent("manager","vue-manager-partners-agreements-list",{data:function(){return{agreements:[],page:1,perPage:100,total:0,isUpdating:!1,percents:[0,5,10,15,20,25,30,35],isFeaching:!1,statuses:{unsigned:"Не подписан",pending:"В ожидании",signed:"Подписан"},statuses_colors:{unsigned:"danger",pending:"warning",signed:"success"}}},props:["page_id"],mixins:[FormModel,ListModel],created:function(){this.$io.on("events:manager.partners.agreements:refresh",this.refresh),this.fetchData()},destroyed:function(){this.$io.off("events:manager.partners.agreements:refresh",this.refresh)},methods:{onPageChange:function(e){this.page=e,this.fetchData()},fetchData:function(e){var t=this;this.isFeaching=!0;function s(e){t.agreements=e.fields,t.isFeaching=!1}!e&&this.checkCache(s)||this.$api.post("manager/partners/agreements/list",{next:this.next,sort_field:this.sortField,sort_order:this.sortOrder}).then(function(e){t.cachePage(e.response.agreements,s)}).catch(function(e){t.isFeaching=!1})},clickRow:function(e){this.$form("vue-manager-partners-agreements-form",{partner_id:e.partner_id},this)}},template:'<div> <vue-component-submenu menu="manager.partners" :page_id="page_id"></vue-component-submenu> <div class="container"> <b-table paginated backend-pagination pagination-simple :data="agreements" :loading="isFeaching" class="has-mb-2 has-mt-3" :per-page="perPage" :total="total" @click="clickRow" @page-change="onPageChange" hoverable> <b-table-column :label="\'Аккаунт\'|gettext" v-slot="props">{{ props.row.email }}</b-table-column> <b-table-column :label="\'Договор\'|gettext" v-slot="props"><div v-if="props.row.agreement_number">{{ props.row.agreement_number }} от {{ props.row.agreement_date|date }}</div></b-table-column> <b-table-column :label="\'Статус\'|gettext" numeric v-slot="props"><div :class="\'has-text-\'+statuses_colors[props.row.agreement_status]">{{statuses[props.row.agreement_status]}}</span></div></b-table-column> </b-table> </div> </div>'}),window.$app.defineComponent("manager","vue-manager-partners-history",{data:function(){return{isFetching:!1,isUpdating:!1,history:[],percents:[0,5,10,15,20,25,30,35],percent:0,max_percent:5}},props:["profile_id","partner_id"],created:function(){var t=this;this.isFetching=!0,this.$api.get("manager/partners/get",{partner_id:this.partner_id}).then(function(e){"success"==e.result&&(t.history=e.response.history,t.max_percent=e.response.max_percent,t.percent=e.response.percent),t.isFetching=!1})},methods:{change:function(){var t=this;this.isUpdating=!0,this.$api.get("manager/partners/set",{partner_id:this.partner_id,percent:this.percent}).then(function(e){"success"==e.result&&(t.history=e.response.history,t.$parent.$parent.fetchData()),t.isUpdating=!1})}},template:'<div class="modal-card modal-card-large"> <header class="modal-card-head"> <p class="modal-card-title">{{\'Партнерская программа\'|gettext}}</p> <button class="modal-close is-large" @click="$parent.close()"></button> </header> <section class="modal-card-body modal-card-body-blocks"> <section> <div class="row row-small"> <div class="col-sm-3 has-mb-2-mobile"> <b-select v-model="percent" expanded> <option value="">-- {{\'Процент отчислений\'|gettext}} --</option> <option :value="p" v-for="p in percents" v-if="p <= max_percent">{{p}}%</option> </b-select> </div> <div class="col-sm-2"> <button class=\'button is-primary is-fullwidth\' :class="{\'is-loading\': isUpdating}" @click="change" expanded>{{\'Изменить\'|gettext}}</button> </div> </div> </section> <section> <b-table :data="history" :paginated="false"> <template slot-scope="props"> <b-table-column :label="\'Дата\'|gettext">{{ props.row.tms|datetime }}</b-table-column> <b-table-column :label="\'Процент\'|gettext">{{ props.row.percent }}%</b-table-column> <b-table-column :label="\'Кто добавил\'|gettext">{{ props.row.email }}</b-table-column> </template> </b-table> </section> </section> <footer class="modal-card-foot"> <button class="button is-dark" type="button" @click="$parent.close()">{{\'Закрыть\'|gettext}}</button> </footer> <b-loading :is-full-page="false" :active.sync="isFetching"></b-loading> </div>'}),window.$app.defineComponent("manager","vue-manager-partners-list",{data:function(){return{partners:[],permissions:{},page:1,perPage:100,total:0,isUpdating:!1,percents:[0,5,10,15,20,25,30,35],form:{nickname:"",percent:"",period:""},max_percent:5,isFeaching:!1}},props:["page_id"],mixins:[FormModel,ListModel],created:function(){this.$io.on("events:manager.partners:refresh",this.refresh),this.permissions={profile:this.$auth.isAllowEndpoint("manager/profiles/get"),add:this.$auth.isAllowEndpoint("manager/partners/add")},this.fetchData()},destroyed:function(){this.$io.off("events:manager.partners:refresh",this.refresh)},methods:{onPageChange:function(e){this.page=e,this.fetchData()},fetchData:function(e){var t=this;this.isFeaching=!0;function s(e){t.partners=e.fields,t.max_percent=e.max_percent,t.isFeaching=!1}!e&&this.checkCache(s)||this.$api.post("manager/partners/list",{next:this.next,sort_field:this.sortField,sort_order:this.sortOrder}).then(function(e){t.cachePage(e.response.partners,s)}).catch(function(e){t.payments=[],t.total=0,t.isFeaching=!1})},openForm:function(e){this.$form("vue-manager-profiles-form",{profile_id:e},this)},addPartner:function(){var s=this;this.isUpdating=!0,this.$api.post("manager/partners/add",this.form,this).then(function(e){"success"==e.result&&_.each(s.form,function(e,t){s.form[t]=""}),s.isUpdating=!1}).catch(function(){s.isUpdating=!1})}},template:'<div> <vue-component-submenu menu="manager.partners" :page_id="page_id"></vue-component-submenu> <div class="container"> <div class="has-mt-2 has-mb-2" v-if="permissions.add"> <div class="row row-small"> <div class="col-sm has-mb-2-mobile"> <b-input type="text" :placeholder="\'Email или имя профиля партнера\'|gettext" v-model="form.nickname" expanded></b-input> </div> <div class="col-sm-3 has-mb-2-mobile"> <b-select v-model="form.percent" expanded> <option value="">-- {{\'Процент отчислений\'|gettext}} --</option> <option :value="p" v-for="p in percents" v-if="p <= max_percent">{{p}}%</option> </b-select> </div> <div class="col-sm-2"> <button class=\'button is-primary is-fullwidth\' :class="{\'is-loading\': isUpdating}" @click="addPartner" expanded>{{\'Добавить\'|gettext}}</button> </div> </div> </div> <b-table paginated backend-pagination pagination-simple :data="partners" :loading="isFeaching" class="has-mb-4" :per-page="perPage" :total="total" @page-change="onPageChange"> <b-table-column field="nickname" :label="\'Аккаунт\'|gettext" v-slot="props"> {{ props.row.email }}<br> <a v-for="profile in props.row.profiles" class="is-block" @click="openForm(profile.profile_id)" v-if="permissions.profile">{{ profile.nickname }}</a> <div v-else>{{ profile.nickname }}</div> </b-table-column> <b-table-column field="manager" :label="\'Кто добавил\'|gettext" class="has-text-grey" v-slot="props">{{ props.row.manager }}</b-table-column> <b-table-column field="percent" :label="\'Процент\'|gettext" v-slot="props">{{ props.row.percent }} %</b-table-column> <b-table-column field="profiles" :label="\'Промокоды\'|gettext" v-slot="props"> <div class="tags" v-if="props.row.promos"><div v-for="promocode in props.row.promos" class="tag is-success">{{ promocode.code }}</div></div> <div v-else class="has-text-danger">{{\'Нет\'|gettext}}</div> </b-table-column> <b-table-column field="profiles" :label="\'Статистика\'|gettext" numeric v-slot="props"> <div v-if="props.row.invited_amount">{{\'Регистрации\'|gettext}}: {{ props.row.invited_amount }}</div> <div v-if="props.row.invited_amount_installed">{{\'Установки\'|gettext}}: {{ props.row.invited_amount_installed }}</div> <div v-if="props.row.invited_orders">{{\'Оплаты\'|gettext}}: {{ props.row.invited_orders }}</div> <div v-if="props.row.invited_budget">{{\'Сумма\'|gettext}}: {{ props.row.invited_budget|currency(\'RUB\') }}</div> </b-table-column> </b-table> </div> </div>'}),window.$app.defineComponent("manager","vue-manager-partners-payouts-form",{data:function(){return{isUpdating:!1,isFetching:!1,values:{payouts:[]}}},created:function(){this.withdrawal_id&&this.fetchData(!0)},props:["withdrawal_id"],mixins:[FormModel],methods:{fetchData:function(e){var t=this;this.isFetching=e,this.$api.get("manager/partners/payouts/get",{withdrawal_id:this.withdrawal_id}).then(function(e){t.isFetching=!1,t.values=e.response.payouts.values})},send:function(e){var t=this;this.isUpdating=!0,this.$api.get("manager/partners/payouts/send",{withdrawal_id:this.withdrawal_id,send:e},this).then(function(e){t.isUpdating=!1,"success"==e.result&&t.$parent.close()})}},template:'<div class="modal-card"> <header class="modal-card-head"> <p class="modal-card-title">Вывод</p> <button class="modal-close is-large" @click="$parent.close()"></button> </header> <section class="modal-card-body"> <label class="label">Сумма:</label> <div class="field has-addons"> <div class="control is-expanded has-feedback"> <number type="text" class="input" disabled="on" :value="values.total" :precision="$account.currency.precision"></number> <a class="form-control-feedback has-text-grey-light"><vue-component-clipboard :text="values.total"></vue-component-clipboard></a> </div> <p class="control"><span class="button is-static">{{values.currency_title}}</span></p> </div> <div class="hr has-mb-3" v-if="!values.is_completed && values.payouts.length> 1"></div> <div class="field has-addons" v-for="f in values.payouts" v-if="!values.is_completed && values.payouts.length> 1"> <div class="control is-expanded"> <number type="text" class="input" disabled="on" :value="f.budget" :precision="$account.currency.precision"></number> </div> <p class="control"><span class="button is-static">{{values.currency_title}}</span></p> </div> <div class="field"> <label class="label">{{values.method}}</label> <div class="has-feedback"> <input type="text" class="input" disabled="on" :value="values.purpose"> <a class="form-control-feedback has-text-grey-light"><vue-component-clipboard :text="values.purpose"></vue-component-clipboard></a> </div> </div> <div class="field" v-if="values.details"> <label class="label">ИНН</label> <div class="has-feedback"> <input type="text" class="input" disabled="on" :value="values.details.inn"> <a class="form-control-feedback has-text-grey-light"><vue-component-clipboard :text="values.details.inn"></vue-component-clipboard></a> </div> </div> <button class="button is-primary" @click="send(1)" :class="{\'is-loading\': isUpdating}" :disabled="values.is_completed == 1 || !$auth.isAllowEndpoint(\'manager/partners/payouts/send\')">Отправить</button> <button class="button is-dark" @click="send(0)" :class="{\'is-loading\': isUpdating}" :disabled="values.is_completed == 1 || !$auth.isAllowEndpoint(\'manager/partners/payouts/send\')">Отметить как оплачено</button> <a :href="\'https://docs.google.com/gview?url=http://p1.taplink.ru/c/agreements/\'+values.agreement_number+\'.docx\'" target="_blank" class="button is-dark">Открыть документ</a> </section> <footer class="modal-card-foot"> <button class="button is-dark" type="button" @click="$parent.close()">{{\'Закрыть\'|gettext}}</button> </footer> <b-loading :is-full-page="false" :active.sync="isFetching"></b-loading> </div>'}),window.$app.defineComponent("manager","vue-manager-partners-payouts-list",{data:function(){return{list:[],permissions:{},total:0,perPage:100,isFetching:!1}},props:["page_id"],mixins:[ListModel],created:function(){this.$io.on("events:manager.partners.payouts:refresh",this.refresh),this.fetchData()},destroyed:function(){this.$io.off("events:manager.partners.payouts:refresh",this.refresh)},methods:{refresh:function(){this.next=null,this.fetchData(!0)},onPageChange:function(e){this.page=e,this.fetchData(!0,!1)},fetchData:function(e){var t=this;this.isFeaching=!0;function s(e){t.list=e.fields}!e&&this.checkCache(s)||this.$api.get("manager/partners/payouts/list",{next:this.next}).then(function(e){t.cachePage(e.response.payouts,s),t.isFeaching=!1}).catch(function(e){throw t.list=[],t.total=0,t.isFeaching=!1,e})},clickRow:function(e){this.$form("vue-manager-partners-payouts-form",{withdrawal_id:e.withdrawal_id},this)}},template:'<div> <vue-component-submenu menu="manager.partners" :page_id="page_id"></vue-component-submenu> <div class="container"> <div class="has-mb-2 has-mt-3"> <b-table paginated backend-pagination pagination-simple :data="list" :loading="isFetching" class="has-mb-4" :per-page="perPage" :total="total" @page-change="onPageChange" @click="clickRow" hoverable> <b-table-column field="email" label="Аккаунт" v-slot="props">{{props.row.email}}</b-table-column> <b-table-column field="is_complete" label="Статус" v-slot="props"><div class="tag" v-if="props.row.is_complete" style="color: #ffffff;background: #5cb85c;">Выполнена</div><div class="tag" v-else style="color: #ffffff;background: #337ab7;">Новая</div></b-table-column> <b-table-column label="Метод" v-slot="props">{{props.row.method}}</b-table-column> <b-table-column field="budget" label="Бюджет" numeric v-slot="props">{{props.row.budget|currency(props.row.currency_title)}}</b-table-column> </b-table> </div> </div> </div>'}),window.$app.defineComponent("manager","vue-manager-payments-form",{data:function(){return{isUpdating:!1,isFetching:!1,values:{},currentTab:"common",refund:{marketing:!1,time:!1,times:[],downgrade:!1,custom:!1},custom:0,isRefunding:!1,do_refund:!1,description:""}},created:function(){this.order_id&&this.fetchData(!0)},props:["order_id"],mixins:[FormModel],computed:{progress:function(){return 100-(this.values.period_days-this.values.period_days_left)/this.values.period_days*100},timeRefund:function(){function e(e){return Math.ceil(100*e)/100}var t,s,a=[],i=this.values.period_days-this.values.period_days_left,n=.7,l={3:.5,6:.7,12:1},o=this.values.price*l[this.values.period];return this.refund.time&&(180<i?(timeUsedPrice=e(o*n),a.push({amount:timeUsedPrice,title:"6 месяцев"}),t=e(o*n*(i-=180)/180),a.push({amount:t,title:"дней: "+i})):90<i?(timeUsedPrice=e(o*l[3]),a.push({amount:timeUsedPrice,title:"3 месяца"}),s=e(o*l[3]*(i-=90)/90),a.push({amount:s,title:"дней: "+i})):a.push({amount:e(this.values.price*(i/this.values.period_days)),title:"дней: "+i})),a},marketingPrice:function(){return.3*this.values.price},downgradePrice:function(){return this.values.prices.pro*{3:1,6:.7,12:.5}[this.values.period]*this.values.period},total_refund:function(){var t=this;if(this.refund.custom)return this.custom;var s=this.values.price;return this.refund.time&&_.each(this.refund.times,function(e){s-=t.timeRefund[e].amount}),this.refund.marketing&&(s-=this.marketingPrice),this.refund.downgrade&&(s-=this.downgradePrice),s},isAllowRefund:function(){return this.$auth.isAllowEndpoint("manager/payments/refund")},isAllowPaid:function(){return this.$auth.isAllowEndpoint("manager/payments/paid")}},methods:{fetchData:function(e){var t=this;this.isFetching=e,this.$api.get("manager/payments/get",{order_id:this.order_id}).then(function(e){t.isFetching=!1,t.values=e.response.payments.values,t.do_refund=-1!=[2,7].indexOf(t.values.refund_payment_provider_id)})},setTab:function(e){this.currentTab=e},doRefund:function(){var t=this;this.$confirm(this.values.receipt?this.$gettext('Для того, чтобы отменить операцию вам необходимо сделать возврат денежных средств клиенту. После нажатия кнопки "Ок" данные о возврате уйдут в ФНС. Вы уже сделали возврат?'):this.$gettext("Аннулировать оплату?"),"is-warning").then(function(){t.isRefunding=!0,t.$api.post("manager/payments/refund",{order_id:t.order_id,receipt:t.values.receipt,budget:t.total_refund,downgrade:t.refund.downgrade,do_refund:t.do_refund},t).then(function(e){"success"==e.result&&(t.isRefunding=!1,t.$parent.$parent.fetchData(),t.currentTab="common",t.fetchData(!0))})})},doPaid:function(){var t=this;this.$confirm("Клиент оплатил?","is-warning").then(function(){t.$api.post("manager/payments/paid",{order_id:t.order_id},t).then(function(e){"success"==e.result&&(t.currentTab="common",t.fetchData(!0))})})},updateData:function(){}},template:'<div class="modal-card modal-card-large"> <header class="modal-card-head"> <p class="modal-card-title">{{\'Оплата\'|gettext}}</p> <button class="modal-close is-large" @click="$parent.close()"></button> </header> <ul class="nav nav-tabs has-text-left"> <li :class="{active: currentTab== \'common\'}"><a @click="setTab(\'common\')">{{\'Общие\'|gettext}}</a></li> <li :class="{active: currentTab== \'refund\'}" v-if="values.period_days_left && isAllowRefund"><a @click="setTab(\'refund\')">{{\'Возврат\'|gettext}}</a></li> </ul> <section class="modal-card-body" v-if="currentTab == \'common\'"> <div class="has-mb-4"> <label class="label is-pulled-left">{{\'Тариф\'|gettext}}: {{values.tariff}}</label> <div class="is-pulled-right has-text-grey" v-if="values.period_days_left">{{\'Осталось {1} из {2}\'|gettext|format(values.period_days_left, values.period_days)}}</div> <progress v-if="(values.order_status_id == 2) && values.period_days_left" class="progress is-success is-small" :value="progress" max="100"></progress> <progress v-else class="progress is-success is-small" value="0" max="100"></progress> </div> <div class="row"> <div class="col-xs-12 col-sm-8"> <div class="field"> <div class="row"> <div class="col-xs-3 has-text-weight-bold">{{\'Цена\'|gettext}}:</div> <div class="col-xs-9"> {{values.price|currency(values.currency_title)}} </div> </div> </div> <div class="field"> <div class="row"> <div class="col-xs-3 has-text-weight-bold">{{\'Статус\'|gettext}}:</div> <div class="col-xs-9"> {{values.order_status|gettext}} <a href="#" v-if="values.order_status != 2 && isAllowPaid" @click="doPaid">{{\'Провести оплату\'|gettext}}</a> </div> </div> </div> <div class="field"> <div class="row"> <div class="col-xs-3 has-text-weight-bold">{{\'Метод оплаты\'|gettext}}:</div> <div class="col-xs-9"> {{values.payment_method_title}} </div> </div> </div> <div class="field"> <div class="row"> <div class="col-xs-3 has-text-weight-bold">{{\'От\'|gettext}}:</div> <div class="col-xs-9"> {{values.tms_modify|datetime}} </div> </div> </div> <div class="field"> <div class="row"> <div class="col-xs-3 has-text-weight-bold">{{\'До\'|gettext}}:</div> <div class="col-xs-9"> <span v-if="values.tariff_tms_until">{{values.tariff_tms_until|datetime}}</span> <span v-else class="has-text-grey">—</span> </div> </div> </div> </div> </div> </section> <section class="modal-card-body" v-if="currentTab == \'refund\'"> <div class="has-mb-2"> <div class="has-mb-1">Цена: {{values.price|currency(values.currency_title)}}</div> <div><b-checkbox v-model="refund.downgrade" :disabled="isRefunding" v-if="values.tariff == \'business\'">Понизить до PRO ( - {{downgradePrice|currency(values.currency_title)}} )</b-checkbox></div> <div><b-checkbox v-model="refund.time" :disabled="isRefunding || refund.downgrade">Вычесть использованное время (дни: {{values.period_days - values.period_days_left}})</b-checkbox></div> <div v-if="timeRefund.length" class="has-ml-3"> <div v-for="(p, i) in timeRefund"><b-checkbox v-model="refund.times" :native-value="i" :disabled="isRefunding || refund.downgrade">{{p.title}} ( - {{p.amount|currency(values.currency_title)}} )</b-checkbox></div> </div> <div><b-checkbox v-model="refund.marketing" :disabled="isRefunding || refund.downgrade">Вычесть 30% ( - {{marketingPrice|currency(values.currency_title)}} )</b-checkbox></div> <div class="has-mb-1"><b-checkbox v-model="refund.custom" :disabled="isRefunding">Указать сумму вручную</b-checkbox> <div v-if="refund.custom"><input type="number" v-model="custom" class="input"></div> </div> <div class="has-mb-1">Итого: {{total_refund|currency(values.currency_title)}}</div> <div v-if="total_refund"> <button class="button is-danger has-mr-2" @click="doRefund" :disabled="isRefunding">Оформить возврат</button> <b-checkbox v-model="do_refund" :disabled="isRefunding || ([2, 7].indexOf(values.refund_payment_provider_id) == -1)">Провести возврат через платежную систему</b-checkbox> </div> </div> </section> <footer class="modal-card-foot"> <button class="button is-dark" type="button" @click="$parent.close()">{{\'Закрыть\'|gettext}}</button> </footer> <b-loading :is-full-page="false" :active.sync="isFetching"></b-loading> </div>'}),window.$app.defineComponent("manager","vue-manager-payments-list",{data:function(){return{payments:[],statisticsGroup:null,statistics:null,isFetching:!1,filter:{query:"",date_from:null,date_until:null,tags:[]},filterTags:["currency","provider","method","country"],statisticsGroups:{payment_provider:this.$gettext("Платежная система"),payment_method:this.$gettext("Метод оплаты"),currency_code:this.$gettext("Валюта"),country:this.$gettext("Страна")},perPage:100,balance:0,total:0,sortField:"tms_modify",sortOrder:"desc",weekdays:this.$getDaysNames(),months:this.$getMonthsNames(),first_day_week:this.$getFirstDayWeek()}},mixins:[ListModel],watch:{statisticsGroup:function(){this.fetchStatistics()}},created:function(){this.fetchData(),this.fetchStatistics()},computed:{totalPayments:function(){return _.sumBy(this.balance,function(e){return e.amount})}},methods:{onFilter:function(){this.fetchStatistics(),this.clearPages(),this.fetchData()},openProfileForm:function(e){this.$form("vue-manager-profiles-form",{profile_id:e},this)},onPageChange:function(e){this.page=e,this.fetchData(!0,!1)},openForm:function(e){this.$form("vue-manager-payments-form",{order_id:e},this)},fetchStatistics:function(){var t=this;this.statistics=null;var e={filter:this.filter};this.$api.post("manager/payments/statistics",this.statisticsGroup?Object.assign(e,{group:this.statisticsGroup}):e).then(function(e){t.statistics=e.response.statistics,e.response.balance.length&&(t.balance=e.response.balance)})},fetchData:function(e,t,s){var a=!(0<arguments.length&&void 0!==e)||e,i=this,n=2<arguments.length&&void 0!==s&&s;this.isFetching=a;function l(e){i.payments=_.map(e.fields,function(e){return e.link="//instagram.com/"+e.username,e.instagram_link="//instagram.com/"+e.username,e}),i.isFetching=!1}!n&&this.checkCache(l)||this.$api.post("manager/payments/list",{next:this.next,sort_field:this.sortField,sort_order:this.sortOrder,filter:this.filter}).then(function(e){var t=e.response.payments;i.cachePage(t,l)}).catch(function(e){throw i.payments=[],i.total=0,i.isFetching=!1,e})},tagsFetch:function(e,t,s){this.$api.get("manager/payments/filters",{query:t,name:e}).then(function(e){s("success"==e.result?e.response.variants:[])})}},template:'<div> <div class="container has-mb-2 has-mt-2"> <div class="has-mb-2" v-if="statistics"> <div v-if="statisticsGroup"> <div style="display: flex;flex-direction: row"> <div class="has-background-grey-light profiles-conversion-bar" style="flex-grow: 1"></div> <b-dropdown v-model="statisticsGroup" class="statistics-group-button" aria-role="list" position="is-bottom-left"> <div data-stage="0" style="width: 1.5rem;height: 1rem;position: absolute;top: 0;" slot="trigger" aria-role="listitem"></div> <b-dropdown-item value="">{{\'Без групировки\'|gettext}}</b-dropdown-item> <hr class="dropdown-divider"> <b-dropdown-item v-for="(t, k) in statisticsGroups" :value="k">{{t}}</b-dropdown-item> </b-dropdown> </div> </div> <div v-for="(s, k) in statistics" class="has-mb-2"> <div v-if="statisticsGroup"><span v-if="k">{{k}}</span><span class="has-text-grey" v-else>{{\'Пустой список\'|gettext}}</span></div> <div style="display: flex;flex-direction: row"> <div class="has-background-grey-light profiles-conversion-bar" style="flex-grow: 1"> <div data-stage="2" :style="{width: s.bars.nopaid}" v-tippy :content="\'Не оплатили: {1} из {2}\'|gettext|format($number(s.values.nopaid), $number(s.values.total))"><span>{{s.bars.nopaid}}</span></div> <div data-stage="5" :style="{width: s.bars.paid}" v-tippy :content="\'Оплатили: {1} из {2}\'|gettext|format($number(s.values.paid), $number(s.values.total))"><span>{{s.bars.paid}}</span></div> </div> <b-dropdown v-model="statisticsGroup" class="statistics-group-button" aria-role="list" position="is-bottom-left" v-if="!statisticsGroup"> <div data-stage="0" style="width: 1.5rem;height: 1rem;position: absolute;top: 0;" slot="trigger" aria-role="listitem"></div> <b-dropdown-item value="">{{\'Без групировки\'|gettext}}</b-dropdown-item> <hr class="dropdown-divider"> <b-dropdown-item v-for="(t, k) in statisticsGroups" :value="k">{{t}}</b-dropdown-item> </b-dropdown> </div> </div> </div> <div class="has-mt-2 has-mb-2 has-background-grey-light profiles-conversion-bar" v-else></div> <mx-item class="mx-item-header"> <div class="item-row row"> <div class="col-xs-12"> <span class="has-mr-2">{{\'Всего оплат\'|gettext}}: {{ totalPayments|number }}</span> {{\'Итого\'|gettext}}: <span v-for="(b, i) in balance" class="has-mr-1">{{b.balance | number}}<span style="opacity: .6"> {{b.currency_title}}</span><span v-if="i < balance.length-1">,</span> </span> </div> </div> </mx-item> </div> <vue-component-filterbox @filter="onFilter" v-model="filter" :with-filters="true" :allow-tags="filterTags" :tags-fetch="tagsFetch" :disabled="isFetching"> <template slot="filters"> <div class="row row-small"> <div class="col-xs-6 col-sm-3 has-mb-2"> <div class="has-feedback"> <b-datepicker :placeholder="\'От\'|gettext" v-model="filter.date_from" icon="calendar-alt" :day-names="weekdays" :month-names="months" :first-day-of-week="first_day_week"></b-datepicker> <a class="form-control-feedback has-text-grey-light" @click="filter.date_from = null"><i class="fal fa-times"></i></a> </div> </div> <div class="col-xs-6 col-sm-3 has-mb-2"> <div class="has-feedback"> <b-datepicker :placeholder="\'До\'|gettext" v-model="filter.date_until" icon="calendar-alt" :day-names="weekdays" :month-names="months" :first-day-of-week="first_day_week"></b-datepicker> <a class="form-control-feedback has-text-grey-light" @click="filter.date_until = null"><i class="fal fa-times"></i></a> </div> </div> </div> </template> </vue-component-filterbox> <div class="container"> <b-table paginated backend-pagination backend-sorting pagination-simple bordered :data="payments" :loading="isFetching" class="has-mb-4" :per-page="perPage" :total="total" :default-sort="[sortField, sortOrder]" @page-change="onPageChange" @sort="onSort"> <b-table-column field="order_id" :label="\'Счет\'|gettext" sortable v-slot="props"><div><span class="has-text-grey-light">№</span> <a href=\'#\' @click="openForm(props.row.order_id)">{{ props.row.order_id }}</a></div></b-table-column> <b-table-column field="order_status_id" :label="\'Оплата\'|gettext" width="10%" sortable v-slot="props"><span :class="{\'has-text-success\': props.row.order_status_id == 2, \'has-text-danger\': props.row.order_status_id != 2}"> <div> <span v-if="props.row.order_status_id == 2">{{\'Оплачен\'|gettext}}</span><span v-else>{{\'Не оплачен\'|gettext}}</span> <span v-if="props.row.fiscal_attribute"> <span v-if="props.row.onlinekassa_error" class="has-text-danger" v-tippy :content="props.row.onlinekassa_error"><i class="fal fa-receipt"></i></span> <span v-else class="has-text-success" v-tippy :content="props.row.fiscal_attribute"><i class="fal fa-receipt"></i></span> </span> </div> </b-table-column> <b-table-column field="payment_provider" :label="\'Система\'|gettext" sortable v-slot="props"><span v-if="props.row.payment_provider">{{ props.row.payment_provider }}</span><span v-else class="has-text-grey-light">—</span></b-table-column> <b-table-column :label="\'Вес\'|gettext" class="has-width-5" numeric v-slot="props"> <span :class="{\'has-text-grey-light\': props.row.weight == 0}">{{ props.row.weight|number }}</span> </b-table-column> <b-table-column field="username" :label="\'Профиль\'|gettext" sortable v-slot="props"><a @click="openProfileForm(props.row.profile_id)">{{ props.row.username }}</a></b-table-column> <b-table-column field="followers":label="\'Подписчиков\'|gettext" numeric sortable v-slot="props"> <div class="tags is-pulled-left is-hidden-mobile"> <a :href=\'props.row.instagram_link\' target="_blank" v-if="props.row.has_username"><span class="tag is-dark">Instagram</span></a> </div> {{ props.row.followers|number }} </b-table-column> <b-table-column field="tms_modify" :label="\'Дата\'|gettext" class="has-text-nowrap" sortable v-slot="props">{{ props.row.tms_modify|datetime }}</b-table-column> <b-table-column field="price" :label="\'Бюджет\'|gettext" numeric v-slot="props"><div>{{ props.row.price|number }}<span class="has-text-grey-light"> {{props.row.currency_title}}</span></div></b-table-column> </b-table> </div> </div>'}),window.$app.defineComponent("manager","vue-manager-profiles-domain-form",{data:function(){return{isUpdating:!1,isFetching:!0,values:{domain_id:null,language_id:null}}},props:["account_id","profileForm"],mixins:[FormModel],created:function(){var s=this;this.$api.get("manager/profiles/getdomain",{account_id:this.account_id},this).then(function(e){var t;"success"==e.result&&(t=e.response,s.values=t.values,s.variants=t.variants,s.isFetching=!1)})},methods:{updateData:function(){var t=this;this.isUpdating=!0,this.$api.post("manager/profiles/setdomain",{account_id:this.account_id,values:this.values},this).then(function(e){"success"==e.result&&(t.profileForm.fetchData(),t.$parent.close()),t.isUpdating=!1}).catch(function(e){t.isUpdating=!1})}},template:'<div class="modal-card"> <header class="modal-card-head"> <p class="modal-card-title">{{\'Смена домена и языка регистрации\'|gettext}}</p> <button class="modal-close is-large" @click="$parent.close()"></button> </header> <section class="modal-card-body"> <b-field :label="\'Домен\'|gettext"> <b-select v-model="values.domain_id" expanded> <option v-for="(domain, domain_id) in variants.domains" :value="domain_id">{{domain}}</option> </b-select> </b-field> <b-field :label="\'Язык\'|gettext"> <b-select v-model="values.language_id" expanded> <option v-for="(language_title, language_id) in variants.languages" :value="language_id">{{language_title}}</option> </b-select> </b-field> </section> <footer class="modal-card-foot"> <button class="button is-dark" type="button" @click="$parent.close()">{{\'Закрыть\'|gettext}}</button> <button class="button is-primary" :class="{\'is-loading\': isUpdating}" @click="updateData">{{\'Сохранить\'|gettext}}</button> </footer> <b-loading :is-full-page="false" :active.sync="isFetching"></b-loading> </div>'}),window.$app.defineComponent("manager","vue-manager-profiles-export-form",{data:function(){return{isUpdating:!1,isRefreshing:!1,isFetching:!1,amount:0,charset:"utf-8",export_products:!1,variants:{}}},created:function(){this.fetchData(!0)},props:["filters","query","tags","date_from","date_until"],computed:{downloadUrl:function(){return"/api/manager/profiles/export/download.csv?filters="+this.filters.join(",")+"&query="+this.query+"&charset="+this.charset+"&tags="+this.tags.join(",")+"&date_from="+(this.date_from?date_format("Y-m-d",this.date_from):"")+"&date_until="+(this.date_until?date_format("Y-m-d",this.date_until):"")}},mixins:[FormModel],methods:{fetchData:function(e){var t=this;this.isRefreshing=this.isFetching=e,this.$api.get("manager/profiles/export/info",{filters:this.filters,query:this.query,tags:this.tags,date_from:this.date_from?date_format("Y-m-d",this.date_from):null,date_until:this.date_until?date_format("Y-m-d",this.date_until):null,charset:this.charset}).then(function(e){t.isFetching=t.isRefreshing=!1,t.variants=e.response.export.info.variants,t.amount=e.response.export.info.amount})},onChanged:function(){var t=this;this.isRefreshing=!0,this.$api.get("manager/profiles/export/calc",{filters:this.filters,query:this.query,charset:this.charset}).then(function(e){t.isRefreshing=!1,t.amount=e.response.export.calc})}},template:'<div class="modal-card"> <header class="modal-card-head"> <p class="modal-card-title">{{\'Экспорт профилей\'|gettext}}</p> <button class="modal-close is-large" @click="$parent.close()"></button> </header> <section class="modal-card-body"> <div class="message is-success"> <div class="message-body"> {{\'Найдено профилей\'|gettext}}: {{ amount|number }} <a :href="downloadUrl" target="frame" class="button is-small is-success is-pulled-right no-ajax" :class="{\'is-loading\': isRefreshing}"><span class="is-hidden-mobile">{{\'Скачать CSV-файл\'|gettext}}</span><span class="is-hidden-tablet">{{\'Скачать\'|gettext}}</span></a> </div> </div> <b-field :label="\'Кодировка\'|gettext"> <b-select v-model="charset" expanded> <option v-for="(v, k) in variants.charset" :value="k">{{ v }}</option> </b-select> </b-field> </section> <footer class="modal-card-foot"> <button class="button is-dark" type="button" @click="$parent.close()">{{\'Закрыть\'|gettext}}</button> </footer> <b-loading :is-full-page="false" :active.sync="isFetching"></b-loading> </div>'}),window.$app.defineComponent("manager","vue-manager-profiles-form",{data:function(){return{profile:{nickname:"",tariff_current:"",avatar_url:"",tags:[]},is_allow_signin:!1,profiles:[],payments:[],transfers:[],adverts:!1,emails:null,errors:{},variants:null,similar_profiles:null,history:null,isFetchingSimilarsProfiles:!1,isFetchingHistory:!1,isFetchingemails:!1,isFetching:!1,isUpdating:!1}},created:function(){this.fetchData()},computed:{link:function(){return{page:"https://taplink.cc/"+this.profile.nickname,instagram:"https://instagram.com/"+this.profile.nickname}}},props:{profile_id:Number,currentTab:{type:String,default:"common"},owner:String},methods:{changeUsernameForm:function(){var t=this,e=prompt("Укажите имя пользователя","");e&&this.$api.post("manager/profiles/setusername",{profile_id:this.profile_id,username:e}).then(function(e){"success"==e.result?t.fetchData():alert(e.message)})},changeEmail:function(){var t=this,e=prompt("Укажите email",this.profile.email);e&&this.$api.post("manager/profiles/setemail",{account_id:this.profile.account_id,email:e}).then(function(e){"success"==e.result?t.fetchData():alert(e.message)})},openDomainForm:function(){this.$form("vue-manager-profiles-domain-form",{account_id:this.profile.account_id,profileForm:this})},changeAccountForm:function(){var t=this,e=prompt("Укажите email акканта","");e&&this.$api.post("manager/profiles/setaccount",{profile_id:this.profile_id,email:e}).then(function(e){"success"==e.result&&t.fetchData()})},openPlanForm:function(){this.$form("vue-manager-profiles-plan-form",{profile_id:this.profile_id,profileForm:this})},openTrialForm:function(){this.$form("vue-manager-profiles-trial-form",{profile_id:this.profile_id,profileForm:this})},setTab:function(e){var t=this;"history"==(this.currentTab=e)&&null==this.history&&(this.isFetchingHistory=!0,this.$api.get("manager/statistics/history/list",{profile_id:this.profile_id}).then(function(e){t.history=e.response.history.fields,t.isFetchingHistory=!1})),"emails"==e&&null==this.emails&&(this.isFetchingHistory=!0,this.$api.get("manager/mails/messages/account",{account_id:this.profile.account_id}).then(function(e){t.emails=e.response.messages.fields,t.isFetchingHistory=!1}))},fetchData:function(){var t=this;this.isFetching=!0,this.$api.get("manager/profiles/get",{profile_id:this.profile_id}).then(function(e){t.isFetching=!1,t.profile=e.response.profile,t.profiles=e.response.profiles,t.payments=e.response.payments,t.transfers=e.response.transfers,t.adverts=e.response.adverts,t.variants=e.response.variants,t.is_allow_signin=e.response.is_allow_signin})},openPartnerForm:function(){this.$form("vue-manager-partners-history",{partner_id:this.profile.partner_id,profile_id:this.profile.profile_id},this)},openPaymentForm:function(e){this.$form("vue-manager-payments-form",{order_id:e},this)}},template:'<div class="modal-card modal-card-large"> <header class="modal-card-head"> <p class="modal-card-title"><img :src="\'//{1}/a/{2}\'|format($account.storage_domain, profile.avatar_url)" style="width: 3rem;height:3rem;border-radius:100%;margin: -1rem .5rem -1rem 0"> {{\'Профиль\'|gettext}} {{profile.nickname}}</p> <button class="modal-close is-large" @click="$parent.close()"></button> </header> <ul class="nav nav-tabs has-text-left"> <li :class="{active: currentTab== \'common\'}"><a @click="setTab(\'common\')">{{\'Общие\'|gettext}}</a></li> <li :class="{active: currentTab== \'payments\'}"><a @click="setTab(\'payments\')">{{\'Оплаты\'|gettext}}</a></li> <li :class="{active: currentTab== \'profiles\'}"><a @click="setTab(\'profiles\')">{{\'Профили\'|gettext}}</a></li> <li :class="{active: currentTab== \'security\'}" v-if="$auth.isAllowEndpoint(\'manager/security/get\')"><a @click="setTab(\'security\')">{{\'Блокировка\'|gettext}}</a></li> <li :class="{active: currentTab== \'transfers\'}"><a @click="setTab(\'transfers\')">{{\'Переносы\'|gettext}}</a></li> <li :class="{active: currentTab== \'history\'}"><a @click="setTab(\'history\')">{{\'История установок\'|gettext}}</a></li> <li :class="{active: currentTab== \'emails\'}" v-if="profile.email"><a @click="setTab(\'emails\')">{{\'Письма\'|gettext}}</a></li> </ul> <section class="modal-card-body" v-if="currentTab == \'common\'"> <div class="row"> <div class="col-xs-12 col-sm-6"> <div class="field"> <div class="row"> <div class="col-xs-3 has-text-weight-bold">{{\'Страница\'|gettext}}:</div> <div class="col-xs-9"> <a target="_blank" :href="link.page">{{profile.nickname}}</a> </div> </div> </div> <div class="field"> <div class="row"> <div class="col-xs-3 has-text-weight-bold">Account ID:</div> <div class="col-xs-9 level"> <div class="level-left"> {{profile.account_id}} </div> <div class="level-right"> <a @click="changeAccountForm" class="is-pulled-right has-text-success" v-if="!profile.has_nickname ?? $auth.isAllowEndpoint(\'manager/profiles/setusername\')">{{\'Сменить\'|gettext}}</a> </div> </div> </div> </div> <div class="field"> <div class="row"> <div class="col-xs-3 has-text-weight-bold">Profile ID:</div> <div class="col-xs-9"> {{profile.profile_id}} </div> </div> </div> <div class="field"> <div class="row"> <div class="col-xs-3 has-text-weight-bold">{{\'Тариф\'|gettext}}:</div> <div class="col-xs-9 level"> <div class="level-left"> <vue-component-tariff-badge v-model="profile.tariff_current" theme="dark"/> <span v-if="profile.tariff_current != \'basic\'" class="control has-text-grey has-ml-1">до {{profile.tms_tariff_until|date}}</span> </div> <div class="level-right"> <a @click="openPlanForm" class="is-pulled-right has-text-success" v-if="$auth.isAllowEndpoint(\'manager/profiles/plans/transfer\')">{{\'Перенести\'|gettext}}</a> </div> </div> </div> </div> <div class="field"> <div class="row"> <div class="col-xs-3 has-text-weight-bold">{{\'Триал\'|gettext}}:</div> <div class="col-xs-9 level"> <div class="level-left"> <p class="control" v-if="profile.trial_tariff"> <vue-component-tariff-badge v-model="profile.trial_tariff" theme="dark"/> <span class="control has-text-grey has-ml-1">до {{profile.trial_tms_until|date}}</span> </p> <p class="control has-text-grey" v-else>-- {{\'Нет\'|gettext}} --</p> </div> <div class="level-right"> <a @click="openTrialForm" class="is-pulled-right has-text-success" v-if="$auth.isAllowEndpoint(\'manager/profiles/trial/set\')">{{\'Активировать\'|gettext}}</a> </div> </div> </div> </div> <div class="field"> <div class="row"> <div class="col-xs-3 has-text-weight-bold">{{\'Домен\'|gettext}}:</div> <div class="col-xs-9 level" v-if="!isFetching"> <div class="level-left"> {{variants.domain_id[profile.domain_id]}} </div> <div class="level-right" v-if="$auth.isAllowEndpoint(\'manager/profiles/setdomain\')"> <a @click="openDomainForm" class="is-pulled-right has-text-success" v-if="$auth.isAllowEndpoint(\'manager/profiles/setdomain\')">{{\'Изменить\'|gettext}}</a> </div> </div> </div> </div> <div class="field"> <div class="row"> <div class="col-xs-3 has-text-weight-bold">Referer:</div> <div class="col-xs-9"> <a v-if="profile.referer" target="_blank" rel="noreferrer" :href="profile.referer">{{profile.referer_domain}}</a> <p class="control has-text-grey" v-else>-- {{\'Нет\'|gettext}} --</p> </div> </div> </div> <div class="field"> <div class="row"> <div class="col-xs-3 has-text-weight-bold">{{\'Метки\'|gettext}}:</div> <div class="col-xs-9"> <span class="tags" v-if="profile.tags.length> 0"> <span v-for="tag in profile.tags" class="tag is-warning">{{ tag }}</span> </span> <p class="control has-text-grey" v-else>-- {{\'Нет\'|gettext}} --</p> </div> </div> </div> <div class="field"> <div class="row"> <div class="col-xs-3 has-text-weight-bold">{{\'Реклама\'|gettext}}:</div> <div class="col-xs-9 level"> <span v-if="adverts">{{adverts}}</span><p class=" has-text-grey" v-else>-- {{\'Нет\'|gettext}} --</p> </div> </div> </div> </div> <div class="col-xs-12 col-sm-6"> <div class="field"> <div class="row"> <div class="col-xs-3 has-text-weight-bold">{{\'Профиль\'|gettext}}:</div> <div class="col-xs-9 level"> <div class="level-left"> <a target="_blank" :href="link.instagram" v-if="profile.has_nickname">@{{profile.nickname}}</a> <p class="control has-text-grey" v-else>-- {{\'Нет\'|gettext}} --</p> </div> <div class="level-right"> <a @click="changeUsernameForm" class="is-pulled-right has-text-success" v-if="!profile.has_nickname ?? $auth.isAllowEndpoint(\'manager/profiles/setusername\')">{{\'Сменить\'|gettext}}</a> </div> </div> </div> </div> <div class="field"> <div class="row"> <div class="col-xs-3 has-text-weight-bold">{{\'Подписчиков\'|gettext}}:</div> <div class="col-xs-9"> {{profile.followers|number}} </div> </div> </div> <div class="field"> <div class="row"> <div class="col-xs-3 has-text-weight-bold">{{\'Био\'|gettext}}:</div> <div class="col-xs-9"> {{profile.biography}} </div> </div> </div> <div class="field"> <div class="row"> <div class="col-xs-3 has-text-weight-bold">{{\'Ссылка\'|gettext}}:</div> <div class="col-xs-9"> <a :href="profile.website_link" target="_blank" v-if="profile.website_domain">{{profile.website_domain}}</a> <p class="control has-text-grey" v-else>-- {{\'Нет\'|gettext}} --</p> </div> </div> </div> <div class="field"> <div class="row"> <div class="col-xs-3 has-text-weight-bold">Email:</div> <div class="col-xs-9 level"> <div class="level-left"> <a :href="\'mailto:{1}\'|format(profile.email)" target="_blank" v-if="profile.email">{{profile.email}}</a> <p class="control has-text-grey" v-else>-- {{\'Нет\'|gettext}} --</p> </div> <div class="level-right"> <a @click="changeEmail" class="is-pulled-right has-text-success" v-if="$auth.isAllowEndpoint(\'manager/profiles/setemail\')">{{\'Сменить\'|gettext}}</a> </div> </div> </div> </div> <div class="field"> <div class="row"> <div class="col-xs-3 has-text-weight-bold">{{\'Кто привел\'|gettext}}:</div> <div class="col-xs-9"> <p v-if="profile.invite_partner_id">{{profile.invite_partner_email}}</p> <p class="control has-text-grey" v-else>-- {{\'Нет\'|gettext}} --</p> </div> </div> </div> <div class="field"> <div class="row"> <div class="col-xs-3 has-text-weight-bold">{{\'Партнерская программа\'|gettext}}:</div> <div class="col-xs-9 level"> <div class="level-left"> <p v-if="profile.partner_id">ID: {{profile.partner_id}} <span class="has-text-grey">{{profile.partner_percent}}%</span></p> <p class="control has-text-grey" v-else>-- {{\'Нет\'|gettext}} --</p> </div> <div class="level-right" v-if="profile.partner_id"> <a @click="openPartnerForm" class="is-pulled-right has-text-success" v-if="$auth.isAllowEndpoint(\'manager/partners/set\')">{{\'Изменить\'|gettext}}</a> </div> </div> </div> </div> </div> </div> </section> <section class="modal-card-body" v-if="currentTab == \'payments\'"> <b-table :data="payments" :paginated="false"> <b-table-column field="order_id" :label="\'Счет\'|gettext" sortable v-slot="props"><span class="has-text-grey-light">№</span> <a href=\'#\' @click="openPaymentForm(props.row.order_id)">{{ props.row.order_id }}</a></b-table-column> <b-table-column field="order_status_id" :label="\'Оплата\'|gettext" width="10%" sortable v-slot="props"><span :class="{\'has-text-success\': props.row.order_status_id == 2, \'has-text-danger\': props.row.order_status_id != 2}"><span v-if="props.row.order_status_id == 2">{{\'Оплачен\'|gettext}}</span><span v-else>{{\'Не оплачен\'|gettext}}</span></span></b-table-column> <b-table-column field="fiscal_attribute" :label="\'Чек\'|gettext" sortable v-slot="props"><span v-if="props.row.onlinekassa_error" class="has-text-danger"><i class="fa fa-exclamation-triangle" v-tippy :content="props.row.onlinekassa_error"></i> Ошибка</span><span v-else><span v-if="props.row.fiscal_attribute">ФП: {{ props.row.fiscal_attribute }}</span><span v-else class="has-text-grey-light">—</span></span></b-table-column> <b-table-column field="tms_modify" :label="\'Дата\'|gettext" sortable v-slot="props">{{ props.row.tms_modify|datetime }}</b-table-column> <b-table-column field="price" :label="\'Бюджет\'|gettext" numeric sortable v-slot="props"><span v-if="props.row.budget != props.row.price" class="has-text-success" style="opacity: .5">{{ props.row.budget|number }} {{props.row.currency_title}}</span> {{ props.row.price|number }}<span class="has-text-grey-light"> {{props.row.currency_title}}</span></b-table-column> <template slot="empty"> <div class="has-text-grey-light has-text-centered">{{\'Оплат нет\'|gettext}}</div> </template> </b-table> </section> <vue-manager-security-form :profile_id="profile_id" v-if="currentTab == \'security\'" :owner="owner"></vue-manager-security-form> <section class="modal-card-body" v-if="currentTab == \'profiles\'"> <p class="has-text-grey">{{\'Список других профилей в данном личном кабинете\'|gettext}}</p> <b-table :data="profiles" class="has-mt-2" :paginated="false"> <b-table-column label="Имя пользователя" v-slot="props"><a @click="$form(\'vue-manager-profiles-form\', {profile_id: props.row.profile_id});">{{ props.row.nickname }}</a></b-table-column> <b-table-column label="Тариф" class="has-width-20" v-slot="props"><vue-component-tariff-badge v-model="props.row.tariff_current" v-if="props.row.has_tariff"/><span class="tag is-default" v-else>basic</span></b-table-column> <b-table-column numeric label="Действителен до" class="has-text-right has-width-20" v-slot="props"><span v-if="props.row.has_tariff">{{ props.row.tms_tariff_until|datetime }}</b-table-column> <template slot="empty"> <div class="has-text-grey-light has-text-centered">{{\'Других профилей нет\'|gettext}}</div> </template> </b-table> </section> <section class="modal-card-body" v-if="currentTab == \'transfers\'"> <b-table :data="transfers" :paginated="false"> <b-table-column :label="\'От кого\'|gettext" v-slot="props">{{props.row.username_from}}</b-table-column> <b-table-column :label="\'Кому\'|gettext" v-slot="props">{{props.row.username_to}}</b-table-column> <b-table-column :label="\'Дата\'|gettext" width="10%" v-slot="props">{{ props.row.tms_transfer|datetime }}</b-table-column> <template slot="empty"> <div class="has-text-grey-light has-text-centered">{{\'Пока ничего нет\'|gettext}}</div> </template> </b-table> </section> <section class="modal-card-body" v-if="currentTab == \'history\'"> <b-table :data="history" v-if="history"> <b-table-column :label="\'Дата\'|gettext" v-slot="props">{{ props.row.tms|date }}</b-table-column> <b-table-column :label="\'Домен\'|gettext" v-slot="props"><span v-if="props.row.website_domain_history">{{ props.row.website_domain_history }}</span><span class="has-text-grey" v-else>{{\'Пока ничего нет\'|gettext}}</span></b-table-column> <template slot="empty"> <div class="has-text-grey-light has-text-centered">{{\'Пока ничего нет\'|gettext}}</div> </template> </b-table> <b-loading :is-full-page="false" :active.sync="isFetchingHistory"></b-loading> </section> <section class="modal-card-body" v-if="currentTab == \'emails\'"> <div class="message is-info"> <div class="message-body">Email: {{profile.email}}</div> </div> <b-table :data="emails" v-if="emails"> <b-table-column :label="\'Дата\'|gettext" v-slot="props">{{ props.row.tms_created|datetime }}</b-table-column> <b-table-column :label="\'Заголовок\'|gettext" v-slot="props">{{ props.row.subject }}</b-table-column> <b-table-column :label="\'Статус\'|gettext" v-slot="props"><span :class="\'has-text-\'+props.row.message_status_classname">{{ props.row.message_status|gettext }}</span></b-table-column> <template slot="empty"> <div class="has-text-grey-light has-text-centered">{{\'Пока ничего нет\'|gettext}}</div> </template> </b-table> <b-loading :is-full-page="false" :active.sync="isFetchingemails"></b-loading> </section> <footer class="modal-card-foot level"> <div class="level-left"> <button @click="$auth.changeProfile(profile_id, () => {$parent.close()})" target="_blank" class="button" v-if="is_allow_signin">Войти в аккаунт</button> </div> <div class="level-right"> <button class="button is-dark" type="button" @click="$parent.close()">{{\'Закрыть\'|gettext}}</button> </div> </footer> <b-loading :is-full-page="false" :active.sync="isFetching"></b-loading> </div>'}),window.$app.defineComponent("manager","vue-manager-profiles-list",{data:function(){return{isFetching:!1,profiles:[],statistics:null,permissions:{},filter:{query:"",tags:[]},perPage:100,sortField:"tms_created",sortOrder:"desc",date_from:null,date_until:null,statisticsGroup:"",weekdays:this.$getDaysNames(),months:this.$getMonthsNames(),first_day_week:this.$getFirstDayWeek(),filterTags:["utm_source","utm_medium","utm_campaign","lang","country","domain","uniq"],statisticsGroups:{lang:this.$gettext("Язык"),country:this.$gettext("Страна"),utm_source:"utm_source",utm_medium:"utm_medium",utm_campaign:"utm_campaign",utm_term:"utm_term",utm_content:"utm_content"},dropdown_items:[{label:this.$gettext("Тарифы"),items:{"tariff:*":this.$gettext("Все тарифы"),"tariff:pro":"pro","tariff:business":"business"}},{label:this.$gettext("Ссылка"),items:{"is_installed:true":this.$gettext("Cсылка стоит"),"is_installed:false":this.$gettext("Cсылка не стоит"),"is_installed_once:true":this.$gettext("Cсылка стояла")}},{label:this.$gettext("Блокировка"),items:{"is_locked:true":this.$gettext("Профиль заблокирован"),"is_locked:false":this.$gettext("Профиль не заблокирован")}}],filter_values:["tariff:*","is_locked:false"]}},mixins:[ListModel],watch:{filter_type:function(){this.clearPages(),this.fetchData()},statisticsGroup:function(){var e=this.getFetchParams();this.fetchStatistics(e)}},beforeRouteUpdate:function(e,t,s){var a=Vue.prototype.$auth;a.isAllowEndpoint("manager/profiles/list")?s():(console.log(1),s(a.prepareMenu(a.getMenu("manager"))[0]))},created:function(){this.$auth.isAllowEndpoint("manager/profiles/list")&&(this.fetchData(!0,!0),this.$io.on("events:manager.profiles.list:refresh",this.refresh),this.permissions={form:this.$auth.isAllowEndpoint("manager/profiles/get"),statistics:this.$auth.isAllowEndpoint("manager/profiles/statistics")})},destroyed:function(){this.$io.off("events:manager.profiles.list:refresh",this.refresh)},methods:{fetchStatistics:function(e){var t=this;this.statistics=null,this.permissions.statistics&&this.$api.get("manager/profiles/statistics",this.statisticsGroup?Object.assign(e,{group:this.statisticsGroup}):e).then(function(e){t.statistics=e.response.profiles.statistics})},onFilter:function(){this.clearPages();var e=this.fetchData(!0,!1);this.fetchStatistics(e)},refresh:function(){this.next=this.current,this.fetchData(!0,!1,!0)},stageTitle:function(e){return{1:"Авторизовался",2:"Указал Email",3:"Добавил блоки",4:"Поставил ссылку",5:"Оплатил тариф"}[e]},onPageChange:function(e){this.page=e,this.fetchData(!0,!1)},getFetchParams:function(){return{next:this.next,count:this.perPage,sort_field:this.sortField,sort_order:this.sortOrder,query:this.filter.query,tags:this.filter.tags,filters:this.filter_values,date_from:this.date_from?date_format("Y-m-d",this.date_from):null,date_until:this.date_until?date_format("Y-m-d",this.date_until):null}},fetchData:function(e,t,s){var a=!(0<arguments.length&&void 0!==e)||e,i=this,n=1<arguments.length&&void 0!==t&&t,l=2<arguments.length&&void 0!==s&&s;this.isFetching=a;function o(e){i.profiles=_.map(e.fields,function(e){return e.instagram_link="//instagram.com/"+e.nickname,e.taplink_link="//taplink.cc/"+e.nickname,e.lang=e.lang?e.lang:"&nbsp;&nbsp;",e.website_title=decodeURI(e.website_domain).replace(/\?.*/g,"?...").replace(/https?\:\/\//,"").replace(/^www\./,""),-1!=e.website_domain.indexOf("taplink.")?e.website_class="has-text-primary":!e.is_installed&&e.is_installed_once?e.website_class="has-text-danger":e.website_class="has-text-black",e}),i.isFetching=!1}var r=this.getFetchParams();return!l&&this.checkCache(o)||this.$nextTick(function(){i.$api.post(n?["manager/profiles/list","manager/info"]:"manager/profiles/list",r).then(function(e){var s;i.cachePage(e.response.profiles,o),n&&(e.response.manager.info.domain_id||(s={"domain:*":"Все домены"},i.filter_values.push("domain:*"),_.each(e.response.manager.domains,function(e,t){s["domain:"+t]="taplink."+e}),i.dropdown_items.push({label:"Домены",items:s})))}).catch(function(e){throw i.payments=[],i.total=0,i.isFetching=!1,e}),i.permissions.statistics&&!i.statistics&&i.fetchStatistics(r)}),r},openForm:function(e){this.$form("vue-manager-profiles-form",{profile_id:e},this)},rowClass:function(e){return e.is_locked?"tr-lock-account":""},openExportForm:function(){this.$form("vue-manager-profiles-export-form",{query:this.filter.query,tags:this.filter.tags,filters:_.clone(this.filter_values),date_from:this.date_from,date_until:this.date_until},this)},tagsFetch:function(e,t,s){0<=["lang","country","uniq"].indexOf(e)?s([]):this.$api.get("manager/profiles/filters",{query:t,name:e}).then(function(e){s("success"==e.result?e.response.variants:[])})},onInputDates:function(){this.clearPages();var e=this.fetchData(!0,!1);this.fetchStatistics(e)}},template:'<div> <div class="container" v-if="permissions.statistics"> <div> <div class="has-mt-2 has-mb-2" v-if="statistics"> <div v-if="statisticsGroup"> <div style="display: flex;flex-direction: row"> <div class="has-background-grey-light profiles-conversion-bar" style="flex-grow: 1"></div> <b-dropdown v-model="statisticsGroup" class="statistics-group-button" aria-role="list" position="is-bottom-left"> <div data-stage="0" style="width: 1.5rem;height: 1rem;position: absolute;top: 0;" slot="trigger" aria-role="listitem"></div> <b-dropdown-item value="">Без групировки</b-dropdown-item> <hr class="dropdown-divider"> <b-dropdown-item v-for="(t, k) in statisticsGroups" :value="k">{{t}}</b-dropdown-item> </b-dropdown> </div> </div> <div v-for="(s, k) in statistics"> <div v-if="statisticsGroup"><span v-if="k">{{k}}</span><span class="has-text-grey" v-else>Пусто</span></div> <div style="display: flex;flex-direction: row"> <div class="has-background-grey-light profiles-conversion-bar" style="flex-grow: 1"> <div data-stage="2" v-if="s && s.bars" :style="{width: s.bars.signup}" v-tippy :content="\'Регистраций: {1}\'|format($number(s.values.total))"><span>{{s.conversions.signup}}</span></div> <div data-stage="3" v-if="s && s.bars" :style="{width: s.bars.blocks}" v-tippy :content="\'Добавили блоки: {1} из {2}\'|format($number(s.values.blocks), $number(s.values.total))"><span>{{s.conversions.blocks}}</span></div> <div data-stage="1" v-if="s && s.bars" :style="{width: s.bars.installed_remove}" v-tippy :content="\'Убрали ссылку: {1} из {2} ({3})\'|format($number(s.values.installed_remove), $number(s.values.installed_once), s.conversions.installed_remove_local)"><span>{{s.conversions.installed_remove}}</span></div> <div data-stage="4" v-if="s && s.bars" :style="{width: s.bars.installed}" v-tippy :content="\'Установлено ссылок: {1} из {2} ({3})\'|format($number(s.values.installed), $number(s.values.installed_once), s.conversions.installed_local)"><span>{{s.conversions.installed}}</span></div> <div data-stage="5" v-if="s && s.bars" :style="{width: s.bars.paid}" v-tippy :content="\'Оплатили: {1} из {2}\'|format($number(s.values.paid), $number(s.values.total))"><span>{{s.conversions.paid}}</span></div> </div> <b-dropdown v-model="statisticsGroup" class="statistics-group-button" aria-role="list" position="is-bottom-left" v-if="!statisticsGroup"> <div data-stage="0" style="width: 1.5rem;height: 1rem;position: absolute;top: 0;" slot="trigger" aria-role="listitem"></div> <b-dropdown-item value="">{{\'Без групировки\'|gettext}}</b-dropdown-item> <hr class="dropdown-divider"> <b-dropdown-item v-for="(t, k) in statisticsGroups" :value="k">{{t}}</b-dropdown-item> </b-dropdown> </div> </div> </div> <div class="has-mt-2 has-mb-2 has-background-grey-light profiles-conversion-bar" v-else></div> </div> </div> <vue-component-filterbox @filter="onFilter" v-model="filter" :tags-fetch="tagsFetch" :disabled="isFetching" :allow-tags="filterTags" :with-filters="true" :with-buttons="true"> <template slot="buttons"> <a @click="openExportForm" class="button is-light is-fullwidth" v-tippy :content="\'Скачать CSV-файл\'|gettext"><i class="fa fas fa-download"></i></a> </template> <template slot="filters"> <div class="row row-small"> <div class="col-sm-3 has-mb-2"> <vue-component-dropdown-checklist :list="dropdown_items" v-model="filter_values" @input="onFilter"></vue-component-dropdown-checklist> </div> <div class="col-xs-6 col-sm-3 has-mb-2"> <div class="has-feedback"> <b-datepicker :placeholder="\'От\'|gettext" v-model="date_from" icon="calendar-alt" :day-names="weekdays" :month-names="months" :first-day-of-week="first_day_week" @input="onInputDates"></b-datepicker> <a class="form-control-feedback has-text-grey-light" @click="date_from = null"><i class="fal fa-times"></i></a> </div> </div> <div class="col-xs-6 col-sm-3 has-mb-2"> <div class="has-feedback"> <b-datepicker :placeholder="\'До\'|gettext" v-model="date_until" icon="calendar-alt" :day-names="weekdays" :month-names="months" :first-day-of-week="first_day_week" @input="onInputDates"></b-datepicker> <a class="form-control-feedback has-text-grey-light" @click="date_until = null"><i class="fal fa-times"></i></a> </div> </div> </div> </template> </vue-component-filterbox> <div class="container has-mb-3"> <b-table paginated backend-pagination backend-sorting pagination-simple :data="profiles" :loading="isFetching" :per-page="perPage" :current-page="page" :total="total" :default-sort="[sortField, sortOrder]" @page-change="onPageChange" @sort="onSort" :row-class="rowClass" bordered> <b-table-column field="nickname" :label="\'Профиль\'|gettext" sortable v-slot="props"> <div v-if="props.row.utm_source" class="has-text-warning is-pulled-right"><span class="">UTM: {{props.row.utm_source}}</span><span v-if="props.row.utm_medium || props.row.utm_campaign" class=""> / {{props.row.utm_medium}}</span><span v-if="props.row.utm_campaign" class=""> / {{props.row.utm_campaign}}</span></div> <span style="display: flex;align-items: center"> <span class="iti__flag iti__flag-box" :class="\'iti__\'+props.row.country" style="display: inline-block" :title="props.row.country"></span> <span class="tag is-default" v-html="props.row.lang" style="width: 24px;margin: 0 .5rem"></span> <a @click="openForm(props.row.profile_id)" v-if="permissions.form" style="flex:1">{{ props.row.nickname }}</a> <span v-else>{{ props.row.nickname }}</span> <span v-if="props.row.profile_status_id == 5" class="has-text-danger" v-tippy :content="\'Профиль заблокирован\'|gettext"><i class="fa fa-exclamation-triangle"></i></span> <span class="tags has-ml-1" v-if="props.row.tags.length"><span v-for="tag in props.row.tags" class="tag">{{tag}}</span></span> </span> </b-table-column> <b-table-column field="weight" :label="\'Вес\'|gettext" cell-class="has-width-5" numeric v-slot="props"> <span :class="{\'has-text-grey-light\': props.row.weight == 0}">{{ props.row.weight|number }}</span> </b-table-column> <b-table-column field="website_link" :label="\'Ссылка\'|gettext" cell-class="has-width-30" v-slot="props"> <div> <span class="profile-stage" :data-stage="props.row.stage" v-tippy :content="stageTitle(props.row.stage)">{{props.row.stage}}</span> <a :href=\'props.row.website_link\' target="_blank" :class="props.row.website_class" v-if="props.row.website_domain">{{ props.row.website_domain }}</a> <div class="tags is-pulled-right is-hidden-mobile"> <span v-if="props.row.is_deleted" class="is-pulled-right tag is-warning" v-tippy :content="\'Этот Instagram отключен\'|gettext">&nbsp;<i class="fas fa-times"></i>&nbsp;</span> <span v-if="props.row.is_locked" class="is-pulled-right tag is-danger" v-tippy :content="\'Этот профиль заблокирован\'|gettext">&nbsp;<i class="fas fa-lock"></i>&nbsp;</span> <span v-if="!props.row.is_installed && props.row.is_installed_once" class="tag is-danger">remove</span> <a :href=\'props.row.taplink_link\' target="_blank"> <span class="tag is-warning" v-if="props.row.trial_tariff">trial</span> <vue-component-tariff-badge v-else v-model="props.row.tariff_current"/> </a> </div> </div> </b-table-column> <b-table-column field="followers" :label="\'Подписчиков\'|gettext" numeric sortable v-slot="props"> <div class="tags is-pulled-left is-hidden-mobile"> <a :href=\'props.row.instagram_link\' target="_blank" v-if="props.row.has_username"><span class="tag is-dark">Instagram</span></a> </div> {{ props.row.followers|number }} </b-table-column> <b-table-column field="tms_created" :label="\'Дата\'|gettext" numeric sortable v-slot="props"> {{ props.row.tms_created|date }} </b-table-column> </b-table> </div> </div>'}),window.$app.defineComponent("manager","vue-manager-profiles-plan-form",{data:function(){return{isUpdating:!1,isFetching:!1,profile_to:""}},props:["profile_id","profileForm"],mixins:[FormModel],mounted:function(){},methods:{updateData:function(){var t=this;this.isUpdating=!0,this.$api.post("manager/profiles/plans/transfer",{profile_from:this.profile_id,profile_to:this.profile_to},this).then(function(e){"success"==e.result&&(t.profileForm.fetchData(),t.$parent.close()),t.isUpdating=!1}).catch(function(e){t.isUpdating=!1})}},template:'<div class="modal-card"> <header class="modal-card-head"> <p class="modal-card-title">{{\'Перенос тарифа\'|gettext}}</p> <button class="modal-close is-large" @click="$parent.close()"></button> </header> <section class="modal-card-body"> <b-field :label="\'Profile ID\'|gettext" :message="errors.profile_to" :class="{\'has-error\': errors.profile_to}"> <b-input v-model="profile_to"> </b-field> </section> <footer class="modal-card-foot"> <button class="button is-dark" type="button" @click="$parent.close()">{{\'Закрыть\'|gettext}}</button> <button class="button is-primary" :class="{\'is-loading\': isUpdating}" @click="updateData">{{\'Перенести\'|gettext}}</button> </footer> <b-loading :is-full-page="false" :active.sync="isFetching"></b-loading> </div>'}),window.$app.defineComponent("manager","vue-manager-profiles-trial-form",{data:function(){return{isUpdating:!1,isFetching:!1,tariff:"",period:""}},props:["profile_id","profileForm"],mixins:[FormModel],mounted:function(){},methods:{updateData:function(){var t=this;this.isUpdating=!0,this.$api.post("manager/profiles/trial/set",{profile_id:this.profile_id,tariff:this.tariff,period:this.period},this).then(function(e){"success"==e.result&&(t.profileForm.fetchData(),t.$parent.close()),t.isUpdating=!1}).catch(function(e){t.isUpdating=!1})}},template:'<div class="modal-card"> <header class="modal-card-head"> <p class="modal-card-title">{{\'Активация пробного периода\'|gettext}}</p> <button class="modal-close is-large" @click="$parent.close()"></button> </header> <section class="modal-card-body"> <b-field :label="\'Тариф\'|gettext" :message="errors.tariff" :class="{\'has-error\': errors.tariff}"> <b-select v-model="tariff" expanded> <option value="">-- {{\'Выберите тариф\'|gettext}} --</option> <option value="pro">PRO</option> <option value="business">BUSINESS</option> </b-select> </b-field> <b-field :label="\'Период\'|gettext" :message="errors.tariff" :class="{\'has-error\': errors.tariff}"> <b-select v-model="period" expanded> <option value="">-- {{\'Выберите период\'|gettext}} --</option> <option value="3">3 days</option> <option value="7">7 days</option> <option value="14">14 days</option> <option value="30">1 months</option> <option value="90">3 months</option> <option value="180">6 months</option> <option value="365">1 year</option> <option value="1825">5 years</option> <option value="3650">10 years</option> </b-select> </b-field> </section> <footer class="modal-card-foot"> <button class="button is-dark" type="button" @click="$parent.close()">{{\'Закрыть\'|gettext}}</button> <button class="button is-primary" :class="{\'is-loading\': isUpdating}" @click="updateData">{{\'Сохранить\'|gettext}}</button> </footer> <b-loading :is-full-page="false" :active.sync="isFetching"></b-loading> </div>'}),window.$app.defineComponent("manager","vue-manager-questions-form",{data:function(){return{isUpdating:!1,isFetching:!1,currentLanguage:null,variants:{languages:{}},values:{questions:{},questions_group_id:null},options:{theme:"snow"}}},created:function(){this.fetchData(!0)},props:["question_id"],mixins:[FormModel],computed:{question:function(){return this.values.questions[this.currentLanguage]}},methods:{fetchData:function(e){var s=this;this.isFetching=e,this.$api.get(this.question_id?["manager/questions/get","manager/questions/info"]:"manager/questions/info",{question_id:this.question_id}).then(function(e){s.isFetching=!1;var t=e.response.questions;s.variants=t.variants,s.question_id&&(s.values=t.values),_.each(t.variants.languages,function(e){null==s.values.questions[e.language_id]&&s.$set(s.values.questions,e.language_id,{question_id:s.question_id,question:"",answer:"",language_id:e.language_id,is_visible:!1})}),s.currentLanguage=1})},updateData:function(){var t=this;this.isUpdating=!0,this.$api.post("manager/questions/set",this.values,this).then(function(e){"success"==e.result&&t.$parent.close(),t.isUpdating=!1}).catch(function(e){t.isUpdating=!1})}},template:'<div class="modal-card modal-card-large"> <header class="modal-card-head"> <p class="modal-card-title">Вопрос</p> <button class="modal-close is-large" @click="$parent.close()"></button> </header> <ul class="nav nav-tabs has-text-left"> <li :class="{active: currentLanguage== l.language_id}" v-for="l in variants.languages"><a @click="currentLanguage = l.language_id">{{l.language_title}}</a></li> </ul> <section class="modal-card-body" v-if="currentLanguage"> <b-field label="Вопрос"> <b-input v-model="question.question"></b-input> </b-field> <b-field :label="\'Ответ\'|gettext" :message="errors.body" :class="{\'has-error\': errors.body}"> <vue-component-editor :options="options" v-model="question.answer" classname="hero-text"></vue-component-editor> </b-field> <mx-toggle v-model="question.is_visible" :title="\'Показывать\'|gettext"></mx-toggle> <mx-toggle v-model="question.is_visible_app" :title="\'Показывать в справочном центре\'|gettext"></mx-toggle> </section> <section class="modal-card-body"> <span class="select"> <select v-model="values.questions_group_id"> <optgroup :label="p.questions_part_title" v-for="p in variants.groups"> <option :value="g.questions_group_id" v-for="g in p.groups">{{g.questions_group_title}}</option> </optgroup> </select> </span> </section> <footer class="modal-card-foot"> <button class="button is-dark" type="button" @click="$parent.close()">{{\'Закрыть\'|gettext}}</button> <button class="button is-primary" :class="{\'is-loading\': isUpdating}" @click="updateData">{{\'Сохранить\'|gettext}}</button> </footer> <b-loading :is-full-page="false" :active.sync="isFetching"></b-loading> </div>'}),window.$app.defineComponent("manager","vue-manager-questions-groups-form",{data:function(){return{currentLanguage:"ru",languages:{},parts:{},currentTab:null,isUpdating:!1,isFetching:!1}},created:function(){this.fetchData(!0)},methods:{fetchData:function(e){var t=this;this.isFetching=e,this.$api.get("manager/questions/groups/get").then(function(e){t.isFetching=!1,t.parts=e.response.questions.parts,t.languages=e.response.questions.languages})},updateData:function(){var t=this;this.isUpdating=!0,this.$api.post("manager/questions/groups/set",{parts:this.parts}).then(function(e){t.isUpdating=!1,t.$parent.close()})},doAddGroup:function(e){var t={};_.each(this.languages,function(e){t[e.language_code]=""}),e.groups.push({questions_group_title:t})},doAddPart:function(){var t={};_.each(this.languages,function(e){t[e.language_code]=""}),this.parts.push({questions_part_name:"",questions_part_title:t,groups:[]})}},template:'<div class="modal-card"> <header class="modal-card-head"> <p class="modal-card-title">Группы</p> <button class="modal-close is-large" @click="$parent.close()"></button> </header> <ul class="nav nav-tabs has-text-left"> <li :class="{active: currentLanguage== l.language_code}" v-for="l in languages"><a @click="currentLanguage = l.language_code">{{l.language_title}}</a></li> </ul> <section class="modal-card-body"> <sortable-list class="form-fields-item-list" lockAxis="y" v-model="parts" use-drag-handle> <sortable-item v-for="(p, i) in parts" class="form-fields-item is-narrow" :index="i" :key="i" :item="p"> <div class="form-fields-item-title has-background-white"> <div v-sortable-handle class="form-fields-item-handle"></div> <span class="row"> <div class="col-xs"> <input type="text" class="input" v-model="p.questions_part_title[currentLanguage]"> </div> <div class="col-xs col-sm-5"> <input type="text" class="input" v-model="p.questions_part_name" placeholder="Имя папки" :disabled="currentLanguage != \'ru\'"> </div> </span> <div style="margin-left: 3rem"> <sortable-list class="form-fields-item-list" lockAxis="y" v-model="p.groups" use-drag-handle> <sortable-item v-for="(g, j) in p.groups" class="form-fields-item is-narrow" :index="j" :key="j" :item="g"> <div class="form-fields-item-title has-background-white"> <div v-sortable-handle class="form-fields-item-handle"></div> <span class="row"> <div class="col-xs"> <input type="text" class="input" v-model="g.questions_group_title[currentLanguage]"> </div> <div class="col-xs col-sm-5"> <input type="text" class="input" v-model="g.questions_group_name" placeholder="Имя подпапки" :disabled="currentLanguage != \'ru\'"> </div> </span> </div> </sortable-item> </sortable-list> <a @click="doAddGroup(p)" class="button is-default is-small has-mb-1 has-mt-1">Добавить группу</a> </div> </div> </sortable-item> </sortable-list> <a @click="doAddPart" class="button is-default is-small has-mb-1 has-mt-1">Добавить раздел</a> </section> <footer class="modal-card-foot"> <button class="button is-dark" type="button" @click="$parent.close()">{{\'Закрыть\'|gettext}}</button> <button class="button is-primary" :class="{\'is-loading\': isUpdating}" @click="updateData">{{\'Сохранить\'|gettext}}</button> </footer> <b-loading :is-full-page="false" :active.sync="isFetching"></b-loading> </div>'}),window.$app.defineComponent("manager","vue-manager-questions-list",{data:function(){return{isFetching:!1,isSortable:!1,variants:{groups:[],languages:{}},filter:{query:""},filter_questions_group_id:"",perPage:100,action:null}},mixins:[ListModel,SortableTable],created:function(){this.$io.on("events:manager.questions.list:refresh",this.refresh),this.fetchData(!0,!0)},destroyed:function(){this.$io.off("events:manager.questions.list:refresh",this.refresh)},methods:{onDropdown:function(e){switch(e){case"newgroup":this.$form("vue-manager-questions-groups-form");break;case"resort":this.isSortable=!0}},refresh:function(){this.clearPages(),this.fetchData(!1,!1,!0)},openForm:function(e){this.$form("vue-manager-questions-form",{question_id:e},this)},fetchData:function(e,t,s){var a=this;!s&&this.checkCache()||(this.isFetching=e,this.$api.get(t?["manager/questions/list","manager/questions/info"]:"manager/questions/list",{next:this.next,count:this.perPage,filter:{questions_group_id:this.filter_questions_group_id,query:this.filter.query}}).then(function(e){a.cachePage(e.response.questions),t&&(a.variants=e.response.questions.variants),a.isFetching=!1}).catch(function(e){throw a.fields=[],a.total=0,a.isFetching=!1,e}))},onReSort:function(e,t,s,a){var i=this;this.isFetching=!0,this.$api.get("manager/questions/sort",{question_id:s.question_id,index_question_id:a.question_id,questions_group_id:this.filter_questions_group_id},this).then(function(e){i.isFetching=!1})},onPageChange:function(e){this.page=e,this.fetchData()}},template:'<div> <vue-component-filterbox :showToolbar="isSortable" @dropdown="onDropdown" v-model="filter" @filter="refresh" :disabled="isFetching" :with-dropdown="true" :with-buttons="true"> <template slot="toolbar"> <a @click="isSortable = false" class="button is-dark"><i class="fal fa-check has-mr-2"></i> Завершить сортировку</a> </template> <template slot="dropdown"> <b-dropdown-item value="newgroup"><i class="fal fa-layer-group has-text-centered has-mr-1"></i> Настроить группы</b-dropdown-item> <b-dropdown-item value="resort" :disabled="filter.query != \'\' || filter_questions_group_id== \'\'"><i class="fal fa-arrows has-text-centered has-mr-1"></i> Сортировать</b-dropdown-item> </template> <template slot="buttons"> <div class="row row-small"> <div class="col-xs"> <span class="select is-fullwidth"> <select v-model="filter_questions_group_id" @change="refresh"> <option value="">-- Все группы --</option> <optgroup :label="p.questions_part_title" v-for="p in variants.groups"> <option :value="g.questions_group_id" v-for="g in p.groups">{{g.questions_group_title}}</option> </optgroup> </select> </span> </div> <div class="col-xs"> <a @click="$form(\'vue-manager-questions-form\')" class="button is-primary is-fullwidth"><i class="fa fa-plus-circle"></i> Добавить вопрос</a> </div> </div> </template> </vue-component-filterbox> <div class="container"> <div class="has-mb-2"> <b-table paginated backend-pagination pagination-simple :data="fields" :loading="isFetching" :per-page="perPage" :total="total" @page-change="onPageChange" :class="{\'is-sortable\': isSortable}" bordered :draggable="isSortable" @dragstart="rowDragStart" @drop="rowDrop" @dragover="rowDragOver" @dragleave="rowDragLeave"> <b-table-column field="question" label="Вопрос" v-slot="props"> <span class="is-pulled-right tags"><span class="tag is-default" v-for="lg in props.row.languages">{{variants.languages[lg].language_code}}</span></span> <a href="#" @click="openForm(props.row.question_id)">{{ props.row.question }}</a><br><span class="has-text-grey">{{props.row.groupname}}</span> </b-table-column> <template slot="empty"> <section class="has-mb-4 has-mt-4 content has-text-grey has-text-centered" v-if="!isFetching"> <p><b-icon icon="frown" size="is-large"></b-icon></p> <p>{{\'Пока ничего нет\'|gettext}}</p> </section> <section class="has-mb-4 has-mt-4 content has-text-grey has-text-centered" v-if="isFetching"> <p>{{\'Загрузка данных\'|gettext}}</p> </section> </template> </b-table> </div> </div> </div>'}),window.$app.defineComponent("manager","vue-manager-security-form",{data:function(){return{isFetching:!1,isUpdating:!1,values:{html:[]},rules:[],pages:[],profiles:[],profilesSelected:[],rulesSelected:[],page_id:null,allow:{suspend:this.$auth.isAllowEndpoint("manager/security/suspend")}}},props:{profile_id:Number,owner:String},created:function(){this.fetchData()},watch:{page_id:function(){this.fetchData()},profile_id:function(){this.page_id=null,this.profilesSelected=[],this.rulesSelected=[]}},methods:{update:function(){var t=this;this.isUpdating=!0,this.$api.get("manager/security/update",{profile_id:this.profile_id,message:this.values.message,comments:this.values.comments}).then(function(e){t.isUpdating=!1,t.fetchDataResponse(e)})},selectAllProfiles:function(){this.profilesSelected=_.map(this.profiles,"profile_id")},fetchData:function(){var t=this;this.isFetching=!0,this.$api.get("manager/security/get",{profile_id:this.profile_id,page_id:this.page_id}).then(function(e){t.fetchDataResponse(e)})},fetchDataResponse:function(e){var t=e.response;"success"==e.result&&(this.values=t.values,this.rules=t.rules,this.profiles=t.profiles,this.pages=t.pages,this.page_id=t.values.page_id,this.isFetching=!1,this.profilesSelected=[t.values.profile_id])},checkNext:function(e){"security"==this.owner?e.response.next?(this.$parent.profile_id=e.response.next,this.$parent.page_id=null,this.$parent.fetchData()):this.$parent.$parent.close():this.fetchData()},suspend:function(){var t=this;this.$confirm("Вы уверены что хотите заблокировать эту ссылку?","is-danger").then(function(){t.isFetching=!0,t.$api.post("manager/security/suspend",{profile_id:t.profile_id,profiles:t.profilesSelected,rules:_.map(t.rulesSelected,function(e){return t.rules[e]})}).then(function(e){t.checkNext(e)})})},skip:function(){var t=this;this.$api.get("manager/security/skip",{profile_id:this.profile_id}).then(function(e){t.checkNext(e)})},good:function(){var t=this;this.$api.get("manager/security/good",{profile_id:this.profile_id}).then(function(e){t.checkNext(e)})},nope:function(){var t=this;this.$api.get("manager/security/nope",{profile_id:this.profile_id}).then(function(e){t.checkNext(e)})}},template:'<section class="modal-card-body modal-card-body-blocks"> <section> <div class="row row-small"> <div :class="{\'col-xs-3\': owner== \'security\', \'col-xs-4\': owner != \'security\'}"><button class="button is-danger level-item is-fullwidth" type="button" @click="suspend" :disabled="!allow.suspend || (values.profile_status_id == 5)">Заблокировать</button></div> <div :class="{\'col-xs-3\': owner== \'security\', \'col-xs-4\': owner != \'security\'}"><button class="button is-warning level-item is-fullwidth" type="button" @click="skip" :disabled="!allow.suspend">Нейтрально</button></div> <div :class="{\'col-xs-3\': owner== \'security\', \'col-xs-4\': owner != \'security\'}"><button class="button is-success level-item is-fullwidth" type="button" @click="good" :disabled="!allow.suspend">Хороший</button></div> <div class="col-xs-3" v-if="owner == \'security\'"><button class="button is-dark level-item is-fullwidth" type="button" @click="nope" :disabled="!allow.suspend || (values.profile_status_id == 5)">Не знаю</button></div> </div> </section> <section> <div v-if="values.profile_status_id == 5"> <div class="message is-danger"> <div class="message-body"> <h4 class="has-mb-1" style="font-weight: bold">{{\'Данная страница заблокирована\'|gettext}}</h4> <b>Причины:</b><br> <ul style="list-style:decimal-leading-zero;margin-left: 3rem"> <li v-for="r in values.reasons"><span :style="r.block_id?\'\':\'text-decoration: line-through\'">{{r.reason}}</span><span v-if="!r.block_id" class="has-ml-2 has-text-danger">(Убрали)</span></li> </ul> </div> </div> <b-field label="Сообщение на странице"> <textarea v-model="values.message" class="input" :disabled="!allow.suspend"></textarea> </b-field> <b-field label="Комментарий"> <textarea v-model="values.comments" class="input" :disabled="!allow.suspend"></textarea> </b-field> <button v-if="allow.suspend" class="button is-success" :class="{\'is-loading\': isUpdating}" v-if="allow.suspend" @click="update">Сохранить</button> </div> <div v-else> <div class="message is-danger" v-if="_.size(values.html)"> <div class="message-body"><a @click="$form(\'vue-manager-security-html-form\', {html: values.html})">HTML-код на странице ({{_.size(values.html)}})</a></div> </div> <div class="row"> <div class="col-sm-6"> <b-table :data="rules" :paginated="false" class="has-mb-2"> <b-table-column field="type" label="type" v-slot="props"><b-checkbox v-model="rulesSelected" :native-value="props.index" :disabled="!allow.suspend">{{props.row.type}}</b-checkbox></b-table-column> <b-table-column field="method" label="method" v-slot="props">{{props.row.method}}</b-table-column> <b-table-column field="rule" label="rule" v-slot="props"> <a :href="\'http://\'+props.row.rule" target="_blank">{{props.row.rule}}</a> <a :href="\'https://developers.facebook.com/tools/debug/?q=\'+encodeURI(props.row.rule)" target="_blank"><i class="far fa-external-link-square-alt"></i></a> </b-table-column> <template slot="empty"> <div class="has-text-grey-light has-text-centered">Ссылок нет</div> </template> </b-table> <b-table :data="profiles" :paginated="false" class="has-mb-2"> <b-table-column field="nickname" label="Имя" v-slot="props"> <b-checkbox v-model="profilesSelected" :native-value="props.row.profile_id" :disabled="!allow.suspend">{{props.row.nickname}}</b-checkbox> </b-table-column> <b-table-column field="link" label="link" v-slot="props"> <a :href="props.row.link" target="_blank" class="{disabled: props.row.profile_id == profile_id}">Открыть</a> </b-table-column> <template slot="empty"> <div class="has-text-grey-light has-text-centered">Похожих профилей нет</div> </template> </b-table> <button class="button is-light" @click="selectAllProfiles" :disabled="profiles.length == 0 || !allow.suspend">Выбрать все</button> </div> <div class="col-sm-6 has-text-centered"> <div class="field has-addons"> <b-select v-model="values.page_id" class="has-mb-2" v-model="page_id" expanded :disabled="_.size(pages) == 1 || isFetching"> <option v-for="(v, k) in pages" :value="k">{{v}}</option> </b-select> <p class="control"> <a :href=\'values.link\' class="button is-light" target="_blank" :disabled="isFetching"><i class="fa fa-external-link"></i></a> </p> </div> <div class="device is-black"> <div class="screen is-clipped" style="width: 262px;height: 466px"> <iframe class="counter-page" scrolling="no" :src="values.link+\'?static=1\'" v-if="!isFetching" style="transform: scale(.5);transform-origin: 0 0;min-width: 524px;min-height: 932px"></iframe> </div> </div> </div> </div> </div> </section> </section>'}),window.$app.defineComponent("manager","vue-manager-security-history",{data:function(){return{isFetching:!1,filter:{query:"",tags:[]},statuses:{2:{title:"Нейтрально",classname:"warning"},3:{title:"Хорошо",classname:"success"},5:{title:"Заблокировано",classname:"danger"}},perPage:100}},props:["page_id"],mixins:[ListModel],created:function(){this.fetchData(!0)},methods:{fetchData:function(e,t){var s=this;!t&&this.checkCache()||(this.isFetching=e,this.$api.get("manager/security/history",{next:this.next,count:this.perPage,filter:this.filter}).then(function(e){s.cachePage(e.response.history),s.isFetching=!1}).catch(function(e){throw s.fields=[],s.total=0,s.isFetching=!1,e}))},onPageChange:function(e){this.page=e,this.fetchData()},clickRow:function(e){this.$form("vue-manager-profiles-form",{profile_id:e.profile_id,currentTab:"security",owner:"security"},this)}},template:'<div> <vue-component-submenu menu="manager.security" :page_id="page_id"></vue-component-submenu> <div class="container has-mt-3"> <div class="has-mb-2"> <b-table paginated backend-pagination pagination-simple :data="fields" :loading="isFetching" :per-page="perPage" :current-page="page" :total="total" :default-sort="[sortField, sortOrder]" @page-change="onPageChange" hoverable bordered @click="clickRow"> <b-table-column field="username" label="Профиль" v-slot="props"> <span class="iti__flag iti__flag-box" :class="\'iti__\'+props.row.country" style="display: inline-block" :title="props.row.country"></span> <span class="tag is-default" v-html="props.row.lang" style="width: 24px;margin: 0 .5rem"></span> {{ props.row.username }} </b-table-column> <b-table-column label="Статус" v-slot="props"> <span :class="\'has-text-\'+statuses[props.row.data.status_id].classname">{{statuses[props.row.data.status_id].title}}</span> </b-table-column> <b-table-column label="Кто" v-slot="props"> {{props.row.owner_email}} </b-table-column> <b-table-column field="tms" :label="\'Дата\'|gettext" numeric sortable v-slot="props"> {{ props.row.tms|datetime}} </b-table-column> <template slot="empty"> <section class="has-mb-4 has-mt-4 content has-text-grey has-text-centered" v-if="!isFetching"> <p><b-icon icon="smile" size="is-large"></b-icon></p> <p>{{\'Пока ничего нет\'|gettext}}</p> </section> <section class="has-mb-4 has-mt-4 content has-text-grey has-text-centered" v-if="isFetching"> <p>{{\'Загрузка данных\'|gettext}}</p> </section> </template> </b-table> </div> </div> </div>'}),window.$app.defineComponent("manager","vue-manager-security-html-form",{props:["html"],created:function(){console.log(this.html)},template:'<div class="modal-card"> <header class="modal-card-head"> <p class="modal-card-title">HTML</p> <button class="modal-close is-large" @click="$parent.close()"></button> </header> <section class="modal-card-body modal-card-body-blocks"> <section v-for="h in html"> <vue-component-codemirror v-model="h" mode="text/html" readonly="true"></vue-component-codemirror> </section> </section> <footer class="modal-card-foot"> <button class="button is-dark level-item" type="button" @click="$parent.close()">{{\'Закрыть\'|gettext}}</button> </footer> </div>'}),window.$app.defineComponent("manager","vue-manager-security-list",{data:function(){return{isFetching:!1,filter:{query:"",tags:[]},perPage:100}},props:["page_id"],mixins:[ListModel],created:function(){this.$io.on("events:manager.security.list:refresh",this.refresh),this.fetchData(!0)},destroyed:function(){this.$io.off("events:manager.security.list:refresh",this.refresh)},methods:{refresh:function(){this.clearPages(),this.fetchData(!1,!0)},fetchData:function(e,t){var s=this;!t&&this.checkCache()||(this.isFetching=e,this.$api.get("manager/security/list",{next:this.next,count:this.perPage,filter:this.filter}).then(function(e){s.cachePage(e.response.locking),s.isFetching=!1}).catch(function(e){throw s.fields=[],s.total=0,s.isFetching=!1,e}))},onPageChange:function(e){this.page=e,this.fetchData()},clickRow:function(e){this.$form("vue-manager-profiles-form",{profile_id:e.profile_id,currentTab:"security",owner:"security"},this)}},template:'<div> <vue-component-submenu menu="manager.security" :page_id="page_id"></vue-component-submenu> <div class="container has-mt-3"> <div class="has-mb-2"> <b-table paginated backend-pagination pagination-simple :data="fields" :loading="isFetching" :per-page="perPage" :current-page="page" :total="total" :default-sort="[sortField, sortOrder]" @page-change="onPageChange" hoverable bordered @click="clickRow"> <b-table-column field="username" label="Профиль" v-slot="props"> <span class="iti__flag iti__flag-box" :class="\'iti__\'+props.row.country" style="display: inline-block" :title="props.row.country"></span> <span class="tag is-default" v-html="props.row.lang" style="width: 24px;margin: 0 .5rem"></span> {{ props.row.username }} </b-table-column> <template slot="empty"> <section class="has-mb-4 has-mt-4 content has-text-grey has-text-centered" v-if="!isFetching"> <p><b-icon icon="smile" size="is-large"></b-icon></p> <p>{{\'Пока ничего нет\'|gettext}}</p> </section> <section class="has-mb-4 has-mt-4 content has-text-grey has-text-centered" v-if="isFetching"> <p>{{\'Загрузка данных\'|gettext}}</p> </section> </template> </b-table> </div> </div> </div>'}),window.$app.defineComponent("manager","vue-manager-statistics-history",{data:function(){return{isUpdating:!1,perPage:100,statistics:null,currentTab:"list"}},mixins:[ListModel],created:function(){this.fetchData(!0)},props:["date","target"],mixins:[ListModel],methods:{setTab:function(e){this.currentTab=e},onPageChange:function(e){this.page=e,this.fetchData(!1)},fetchData:function(e,t){var s=this;this.isFetching=e;function a(e){null!=e.statistics&&(s.statistics=e.statistics),s.fields=e.fields,s.isFetching=!1}!t&&this.checkCache(a)||this.$api.get("manager/statistics/history/list",{date:this.date,target:this.target,next:this.next}).then(function(e){s.isFetching=!1,s.cachePage(e.response.history,a)})}},template:'<div class="modal-card modal-card-large"> <header class="modal-card-head"> <p class="modal-card-title" v-if="target == \'install\'">{{\'История установок\'|gettext}} {{date}}</p> <p class="modal-card-title" v-else>{{\'История удалений\'|gettext}} {{date}}</p> <button class="modal-close is-large" @click="$parent.close()"></button> </header> <ul class="nav nav-tabs has-text-left"> <li :class="{active: currentTab== \'list\'}"><a @click="setTab(\'list\')">{{\'Список\'|gettext}}</a></li> <li :class="{active: currentTab== \'statistics\'}"><a @click="setTab(\'statistics\')">{{\'Статистика\'|gettext}}</a></li> </ul> <section class="modal-card-body" v-if="currentTab == \'list\'"> <b-table :data="fields" paginated backend-pagination pagination-simple :per-page="perPage" :current-page="page" :total="total" @page-change="onPageChange"> <b-table-column :label="\'Имя пользователя\'|gettext" v-slot="props"><a @click="$form(\'vue-manager-profiles-form\', {profile_id: props.row.profile_id});">{{ props.row.username }}</a></b-table-column> <b-table-column :label="\'Домен\'|gettext" v-slot="props"><span v-if="props.row.website_domain_history">{{ props.row.website_domain_history }}</span><span class="has-text-grey" v-else>{{\'Пусто\'|gettext}}</span></b-table-column> <b-table-column :label="\'Домен сейчас\'|gettext" v-slot="props"><span v-if="props.row.website_domain" class="has-text-grey-light">{{ props.row.website_domain }}</span><span class="has-text-grey-light" v-else>{{\'Пусто\'|gettext}}</span></b-table-column> <b-table-column :label="\'Подписчиков\'|gettext" numeric v-slot="props">{{ props.row.followers|number }}</b-table-column> <template slot="empty"> <div class="has-text-grey-light has-text-centered">{{\'Список пуст\'|gettext}}</div> </template> </b-table> </section> <section class="modal-card-body" v-if="currentTab == \'statistics\'"> <b-table :data="statistics"> <b-table-column :label="\'Изменение\'|gettext" v-slot="props"><span v-if="props.row.website_domain">{{ props.row.website_domain }}</span><span class="has-text-grey" v-else>{{\'Пусто\'|gettext}}</span></b-table-column> <b-table-column :label="\'Количество\'|gettext" numeric v-slot="props">{{ props.row.amount|number }}</b-table-column> <template slot="empty"> <div class="has-text-grey-light has-text-centered">{{\'Список пуст\'|gettext}}</div> </template> </b-table> </section> <footer class="modal-card-foot"> <button class="button is-dark" type="button" @click="$parent.close()">{{\'Закрыть\'|gettext}}</button> </footer> <b-loading :is-full-page="false" :active.sync="isFetching"></b-loading> </div>'}),window.$app.defineComponent("manager","vue-manager-statistics-list",{data:function(){return{isFetching:!1,perPage:50,period:"month",segment:"day",is_allow_payments:!1}},mixins:[ListModel],created:function(){this.fetchData(!0)},watch:{period:function(){this.clearPages(),this.fetchData(!0,!0)},segment:function(){this.clearPages(),this.fetchData(!0,!0)}},methods:{showInstalled:function(e){this.$form("vue-manager-statistics-history",{date:e,target:"install"},this)},showUninstalled:function(e){this.$form("vue-manager-statistics-history",{date:e,target:"uninstall"},this)},fetchData:function(e,t){function s(e){a.fields=e.fields,a.is_allow_payments=e.is_allow_payments,a.isFetching=!1}var a=this;!t&&this.checkCache(s)||(this.isFetching=e,this.$api.post("manager/statistics/list",{next:this.next,count:this.perPage,period:this.period,segment:this.segment}).then(function(e){a.cachePage(e.response.statistics,s)}).catch(function(e){throw a.fields=[],a.total=0,a.isFetching=!1,e}))}},template:'<div> <div class="container has-mb-2 has-mt-2"> <div class="row"> <div class="col-sm-5 col-md-4 col-xs-12 has-xs-mb-2"> <b-field class="has-tabs-style"> <b-radio-button v-model="period" type="active" class="is-expanded" native-value="month">{{\'Месяц\'|gettext}}</b-radio-button> <b-radio-button v-model="period" type="active" class="is-expanded" native-value="quarter">{{\'Квартал\'|gettext}}</b-radio-button> <b-radio-button v-model="period" type="active" class="is-expanded" native-value="year">{{\'Год\'|gettext}}</b-radio-button> <b-radio-button v-model="period" type="active" class="is-expanded" native-value="all">{{\'Все\'|gettext}}</b-radio-button> </b-field> </div> <div class="col-sm-5 col-sm-offset-2 col-md-offset-3 col-lg-3 col-lg-offset-5 has-mb-2 col-xs-12"> <b-field class="has-tabs-style"> <b-radio-button v-model="segment" type="active" class="is-expanded" native-value="day">{{\'По дням\'|gettext}}</b-radio-button> <b-radio-button v-model="segment" type="active" class="is-expanded" native-value="month">{{\'По месяцам\'|gettext}}</b-radio-button> <b-radio-button v-model="segment" type="active" class="is-expanded" native-value="year">{{\'По годам\'|gettext}}</b-radio-button> </b-field> </div> </div> <b-table paginated backend-pagination pagination-simple bordered :data="fields" :loading="isFetching" :per-page="perPage" :total="total" @page-change="onPageChange"> <b-table-column :label="\'Дата\'|gettext" cell-class="has-width-10" v-slot="props">{{ props.row.tms }}</b-table-column> <b-table-column :label="\'Регистрации\'|gettext" cell-class="has-width-5" numeric v-slot="props">{{ props.row.amount|number }}</b-table-column> <b-table-column :label="\'Установили\'|gettext" cell-class="has-width-10" numeric v-slot="props"><div><span class="is-pulled-left has-text-grey-light has-mr-1">{{ props.row.amount_install_once/props.row.amount*100|decimal }}%</span> {{ props.row.amount_install_once|number }}</div></b-table-column> <b-table-column :label="\'Убрали\'|gettext" cell-class="has-width-10" numeric v-slot="props"><div><span class="is-pulled-left has-text-grey-light has-mr-1">{{ (props.row.amount_install_once - props.row.amount_install)/props.row.amount_install_once*100|decimal }}%</span>{{ props.row.amount_install_once - props.row.amount_install|number }}</div></b-table-column> <b-table-column :label="\'Установки всего\'|gettext" cell-class="has-width-15" numeric v-slot="props"><div><span class="is-pulled-left has-text-grey has-mr-2-mobile">{{ props.row.is_installed_followers|number }}</span><a @click="showInstalled(props.row.tms)" v-if="segment == \'day\'">{{ props.row.is_installed|number }}</a><span v-else>{{ props.row.is_installed|number }}</span></div></b-table-column> <b-table-column :label="\'Удаления всего\'|gettext" cell-class="has-width-15" numeric v-slot="props"><div><span class="is-pulled-left has-text-grey has-mr-2-mobile">{{ props.row.is_uninstalled_followers|number }}</span><a @click="showUninstalled(props.row.tms)" v-if="segment == \'day\'">{{ props.row.is_uninstalled|number }}</a><span v-else>{{ props.row.is_uninstalled|number }}</span></div></b-table-column> <b-table-column :label="\'Рост\'|gettext" numeric cell-class="has-width-15" v-slot="props"><div :class="{\'has-text-success\': props.row.is_installed - props.row.is_uninstalled> 0, \'has-text-danger\': props.row.is_installed - props.row.is_uninstalled < 0}"><span class="is-pulled-left has-mr-2-mobile" :class="{\'has-text-danger\': props.row.is_installed_followers < props.row.is_uninstalled_followers, \'has-text-grey\': props.row.is_installed_followers>= props.row.is_uninstalled_followers}">{{ props.row.is_installed_followers - props.row.is_uninstalled_followers|number }}</span>{{ props.row.is_installed - props.row.is_uninstalled|number }}</div></b-table-column> <b-table-column :label="\'Оплаты\'|gettext" numeric v-if="is_allow_payments" v-slot="props"> <span> <span v-for="v in props.row.budget" class=\'table-price\'> {{ v.budget|number }}<span class="has-text-grey-light"> {{v.currency_title}}</span> </span> </span> </b-table-column> <template slot="empty"> <section class="has-mb-4 has-mt-4 content has-text-grey has-text-centered" v-if="!isFetching"> <p><b-icon icon="frown" size="is-large"></b-icon></p> <p>{{\'Пока ничего нет\'|gettext}}</p> </section> <section class="has-mb-4 has-mt-4 content has-text-grey has-text-centered" v-if="isFetching"> <p>{{\'Загрузка данных\'|gettext}}</p> </section> </template> </b-table> </div> </div>'}),window.$app.defineModule("manager",[{path:"profiles/",component:"vue-manager-profiles-list",meta:{title:"Профили",endpoint:"manager/profiles/list"},props:!0,name:"manager.profiles"},{path:"statistics/",component:"vue-manager-statistics-list",meta:{title:"Статистика",endpoint:"manager/statistics/list"},props:!0,name:"manager.statistics"},{path:"payments/",component:"vue-manager-payments-list",meta:{title:"Оплаты",endpoint:"manager/payments/list"},props:!0,name:"manager.payments"},{path:"partners/",redirect:"partners/list/",name:"manager.partners",meta:{title:"Партнеры",endpoint:"manager/partners/list"},children:[{path:"list/",component:"vue-manager-partners-list",meta:{title:"Список",endpoint:"manager/partners/list"},props:!0,name:"manager.partners.list"},{path:"payouts/",component:"vue-manager-partners-payouts-list",meta:{title:"Выплаты",endpoint:"manager/partners/payouts/list"},props:!0,name:"manager.payouts.list"},{path:"agreements/",component:"vue-manager-partners-agreements-list",meta:{title:"Договора",endpoint:"manager/partners/agreements/list"},props:!0,name:"manager.agreements.list"}]},{path:"locales/",component:"vue-manager-locales-index",meta:{title:"Языки",endpoint:"manager/locales/get"},props:!0,name:"manager.locales.index",children:[{path:":current/",component:"vue-manager-locales",name:"manager.locales",props:!0}]},{path:"mails/",redirect:"mails/messages/",name:"manager.mails",meta:{title:"Почта",endpoint:"manager/mails/messages/list"},children:[{path:"messages/",component:"vue-manager-mails-messages-list",meta:{title:"Письма",endpoint:"manager/mails/messages/list"},props:!0,name:"manager.mails.messages.list"},{path:"campaings/",component:"vue-manager-mails-campaings-list",meta:{title:"Рассылки",endpoint:"manager/mails/campaings/list"},props:!0,name:"manager.mails.campaings.list"},{path:"sequences/",component:"vue-manager-mails-sequences-list",meta:{title:"Цепочки",endpoint:"manager/mails/sequences/list"},props:!0,name:"manager.mails.sequences.list"}]},{path:"currency/",component:"vue-manager-currency",meta:{title:"Валюта",endpoint:"manager/currency/get"},props:!0,name:"manager.currency"},{path:"security/",redirect:"security/watch/",meta:{title:"Проверка",endpoint:"manager/security/list"},props:!0,name:"manager.security",children:[{path:"watch/",component:"vue-manager-security-list",meta:{title:"На проверку",endpoint:"manager/security/list"},props:!0,name:"manager.security.list"},{path:"history/",component:"vue-manager-security-history",meta:{title:"История",endpoint:"manager/security/list"},props:!0,name:"manager.security.history"}]},{path:"questions/",component:"vue-manager-questions-list",meta:{title:"FAQ",endpoint:"manager/questions/list"},props:!0,name:"manager.questions"},{path:"blog/",component:"vue-manager-blog-list",meta:{title:"Блог",endpoint:"manager/blog/list"},props:!0,name:"manager.blog"},{path:"guides/",component:"vue-manager-guides-list",meta:{title:"Инструкции",endpoint:"manager/guides/list"},props:!0,name:"manager.guides"},{path:"logs/",component:"vue-manager-logs-list",meta:{title:"Логи",endpoint:"manager/logs/list"},props:!0,name:"manager.logs"}]);
